<div class="torneos-wrapper">
  <div class="page-header">
    <h1>Torneos Disponibles</h1>
    <p>Explora y únete a los mejores torneos deportivos</p>
  </div>

  <div class="filters">
    <button [class.active]="filterStatus === 'todos'" (click)="setFilter('todos')">Todos</button>
    <button class="btn-en-curso" [class.active]="filterStatus === 'en_curso'" (click)="setFilter('en_curso')">
      En Curso
    </button>
    <button [class.active]="filterStatus === 'abierto'" (click)="setFilter('abierto')">Inscripción Abierta</button>
    <button [class.active]="filterStatus === 'finalizado'" (click)="setFilter('finalizado')">Finalizados</button>
  </div>

  <div class="loading" *ngIf="isLoading">
    <div class="spinner"></div>
    <p>Cargando torneos...</p>
  </div>

  <div class="error-message" *ngIf="error">
    <p>{{ error }}</p>
  </div>

  <div class="torneos-grid" *ngIf="!isLoading && !error">
    <div class="torneo-card card card-hover card-interactive"
         *ngFor="let torneo of torneosFiltrados"
         (click)="viewTournamentDetail(torneo)">

      <div class="card-header">
        <img [src]="torneo.deporte_imagen" [alt]="torneo.nombre_deporte" class="deporte-icon">
        <div class="header-info">
          <h3>{{ torneo.nombre }}</h3>
          <p>{{ torneo.nombre_deporte }}</p>
        </div>
        <span class="status-badge badge" [class]="'badge-' + torneo.estado">
          {{ getTextoEstado(torneo.estado) }}
        </span>
      </div>

      <div class="card-body">
        <div class="info-row">
          <div class="info-item">
            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <path d="M16 21v-2a4 4 0 0 0-4-4H6a4 4 0 0 0-4 4v2"></path>
              <circle cx="9" cy="7" r="4"></circle>
              <path d="M22 21v-2a4 4 0 0 0-3-3.87"></path>
              <path d="M16 3.13a4 4 0 0 1 0 7.75"></path>
            </svg>
            <span class="label">Equipos:</span>
            <span class="value">{{ torneo.equipos_inscritos }}/{{ torneo.max_equipos }}</span>
          </div>
          <div class="info-item">
            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <path d="M12 2L2 7l10 5 10-5-10-5z"></path>
              <path d="M2 17l10 5 10-5"></path>
              <path d="M2 12l10 5 10-5"></path>
            </svg>
            <span class="label">Tipo:</span>
            <span class="value">{{ torneo.tipo_torneo }}</span>
          </div>
        </div>

        <div class="info-row">
          <div class="info-item">
            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <rect x="3" y="4" width="18" height="18" rx="2" ry="2"></rect>
              <line x1="16" y1="2" x2="16" y2="6"></line>
              <line x1="8" y1="2" x2="8" y2="6"></line>
              <line x1="3" y1="10" x2="21" y2="10"></line>
            </svg>
            <span class="label">Inicio:</span>
            <span class="value">{{ torneo.fecha_inicio | date:'dd/MM/yyyy' }}</span>
          </div>
          <div class="info-item">
            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <polyline points="9 11 12 14 22 4"></polyline>
              <path d="M21 12v7a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h11"></path>
            </svg>
            <span class="label">Fin:</span>
            <span class="value">{{ torneo.fecha_fin | date:'dd/MM/yyyy' }}</span>
          </div>
        </div>

        <div class="info-row" *ngIf="torneo.fecha_cierre_inscripcion && torneo.estado === 'abierto'">
          <div class="info-item">
            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <circle cx="12" cy="12" r="10"></circle>
              <polyline points="12 6 12 12 16 14"></polyline>
            </svg>
            <span class="label">Cierre inscripciones:</span>
            <span class="value">{{ torneo.fecha_cierre_inscripcion | date:'dd/MM/yyyy HH:mm' }}</span>
          </div>
        </div>

        <div class="progress-section" *ngIf="torneo.estado === 'abierto'">
          <div class="progress-header">
            <span>Cupos</span>
            <span>{{ getPorcentajeOcupacion(torneo) }}%</span>
          </div>
          <div class="progress-bar">
            <div class="progress-fill" [style.width.%]="getPorcentajeOcupacion(torneo)"></div>
          </div>
        </div>

        <p class="description" *ngIf="torneo.descripcion">{{ torneo.descripcion }}</p>
      </div>

      <div class="card-footer">
        <button class="btn btn-secondary btn-sm" (click)="quickView(torneo, $event)">
          Vista Rápida
        </button>

        <button
          *ngIf="torneo.estado === 'abierto' && tieneCupos(torneo)"
          class="btn btn-primary btn-sm"
          (click)="onQuickViewInscribirse(torneo); $event.stopPropagation()">
          Inscribirse
        </button>

        <button class="btn btn-ghost btn-sm" (click)="viewBracket(torneo, $event)">
          <i class="fas fa-sitemap"></i>
          Ver Bracket
        </button>
      </div>
    </div>
  </div>

  <div class="empty-state" *ngIf="!isLoading && !error && torneosFiltrados.length === 0">
    <svg class="empty-icon" width="80" height="80" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5">
      <path d="M6 9H4.5a2.5 2.5 0 0 1 0-5H6"></path>
      <path d="M18 9h1.5a2.5 2.5 0 0 0 0-5H18"></path>
      <path d="M4 22h16"></path>
      <path d="M10 14.66V17c0 .55-.47.98-.97 1.21C7.85 18.75 7 20.24 7 22"></path>
      <path d="M14 14.66V17c0 .55.47.98.97 1.21C16.15 18.75 17 20.24 17 22"></path>
      <path d="M18 2H6v7a6 6 0 0 0 12 0V2Z"></path>
    </svg>
    <p class="empty-title">No se encontraron torneos</p>
    <p class="empty-subtitle">Prueba ajustando los filtros o vuelve más tarde</p>
  </div>
</div>

<app-torneo-quick-view-modal
  [isOpen]="showQuickViewModal"
  [torneo]="torneoSeleccionado"
  (cerrar)="onQuickViewModalCerrar()"
  (inscribirse)="onQuickViewInscribirse($event)">
</app-torneo-quick-view-modal>

<app-inscripcion-modal
  [isOpen]="showInscripcionModal"
  [torneo]="torneoSeleccionado"
  [equiposDisponibles]="equiposDelTorneo"
  (cerrar)="onInscripcionModalCerrar()"
  (inscripcionExitosa)="onInscripcionExitosa($event)">
</app-inscripcion-modal>

<!-- Modal Bracket -->
<div class="modal-overlay" *ngIf="showBracketModal && torneoSeleccionado" (click)="closeBracketModal()">
  <div class="modal-bracket" (click)="$event.stopPropagation()">
    <div class="modal-header-bracket">
      <h2>
        <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
          <path d="M3 3v18"></path>
          <path d="M3 12h9"></path>
          <path d="M12 3v18"></path>
          <path d="M12 6h9"></path>
          <path d="M12 18h9"></path>
        </svg>
        Bracket: {{ torneoSeleccionado.nombre }}
      </h2>
      <button class="btn-close-bracket" (click)="closeBracketModal()">
        <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
          <line x1="18" y1="6" x2="6" y2="18"></line>
          <line x1="6" y1="6" x2="18" y2="18"></line>
        </svg>
      </button>
    </div>

    <div class="modal-body-bracket">
      <div class="bracket-container" *ngIf="bracket.length > 0">
        <div class="bracket-ronda" *ngFor="let ronda of bracket">
          <div class="ronda-header">
            <h3>{{ ronda.nombre }}</h3>
          </div>
          <div class="partidos-lista">
            <div class="partido-wrapper" *ngFor="let partido of ronda.partidos">
              <div class="partido-card">
                <div class="equipo" [class.ganador]="partido.ganador === 1">
                  <div class="equipo-info" *ngIf="partido.equipo1; else tbdTemplate1">
                    <img *ngIf="partido.equipo1.logo" [src]="partido.equipo1.logo" [alt]="partido.equipo1.nombre" class="equipo-logo-small">
                    <div *ngIf="!partido.equipo1.logo" class="equipo-logo-placeholder">
                      <svg width="16" height="16" viewBox="0 0 24 24" fill="currentColor">
                        <path d="M12 2L2 7l10 5 10-5-10-5z"></path>
                      </svg>
                    </div>
                    <span class="equipo-nombre">{{ partido.equipo1.nombre }}</span>
                    <span class="equipo-seed">#{{ partido.equipo1.seed }}</span>
                  </div>
                  <ng-template #tbdTemplate1>
                    <span class="equipo-placeholder">TBD</span>
                  </ng-template>
                </div>
                <div class="vs-divider">VS</div>
                <div class="equipo" [class.ganador]="partido.ganador === 2">
                  <div class="equipo-info" *ngIf="partido.equipo2; else tbdTemplate2">
                    <img *ngIf="partido.equipo2.logo" [src]="partido.equipo2.logo" [alt]="partido.equipo2.nombre" class="equipo-logo-small">
                    <div *ngIf="!partido.equipo2.logo" class="equipo-logo-placeholder">
                      <svg width="16" height="16" viewBox="0 0 24 24" fill="currentColor">
                        <path d="M12 2L2 7l10 5 10-5-10-5z"></path>
                      </svg>
                    </div>
                    <span class="equipo-nombre">{{ partido.equipo2.nombre }}</span>
                    <span class="equipo-seed">#{{ partido.equipo2.seed }}</span>
                  </div>
                  <ng-template #tbdTemplate2>
                    <span class="equipo-placeholder">TBD</span>
                  </ng-template>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
      <div class="empty-bracket"  *ngIf="bracket.length === 0" >
        <i class="fas fa-sitemap"></i>
        <p>No hay equipos inscritos en este torneo aún</p>
      </div>
    </div>
  </div>
</div>
