<div class="detalle-cancha-container">

  <!-- Breadcrumb -->
  <nav class="breadcrumb">
    <a routerLink="/reservar-cancha">
      <span class="material-icons">arrow_back</span>
      Volver a Canchas
    </a>
    <span class="breadcrumb-separator">/</span>
    <span class="current">{{ cancha?.nombre_cancha }}</span>
  </nav>

  <!-- Header de la Cancha -->
  <div class="cancha-header-main">
    <div class="header-left">
      <h1 class="cancha-titulo">{{ cancha?.nombre_cancha }}</h1>
      <div class="cancha-meta">
        <div class="rating-display">
          <i class="fas fa-star"></i>
          <span class="rating-value">{{ promedioEstrellas || 0 | number: '1.1-1' }}</span>
          <span class="reviews-count">({{ totalRatings || 0 }} opiniones)</span>
        </div>
        <div class="sede-info">
          <span class="material-icons">location_on</span>
          <span>{{ sede?.nombre_sede }}</span>
        </div>
      </div>
    </div>
    <div class="header-right">
      <div class="precio-destacado">
        <span class="precio-label">Desde</span>
        <span class="precio-valor">${{ cancha?.tarifa | number : '1.2-2' }}</span>
        <span class="precio-unidad">/hora</span>
      </div>
    </div>
  </div>

  <!-- Layout Principal: Imagen + Info -->
  <div class="main-content-grid">

    <!-- Columna Izquierda: Imagen -->
    <div class="imagen-section">
      <div class="imagen-principal">
        <img
          [src]="cancha?.imagen_url || 'https://via.placeholder.com/640x320?text=Sin+Imagen'"
          [alt]="cancha?.nombre_cancha">
        <div class="badges">
          <span class="badge tipo-cancha">
            <span class="material-icons">grass</span>
            {{ cancha?.tipo_superficie }}
          </span>
          <span class="badge estado" [attr.data-estado]="cancha?.estado">
            <span class="material-icons">check_circle</span>
            {{ cancha?.estado }}
          </span>
        </div>
      </div>

      <!-- Características de la Cancha -->
      <div class="caracteristicas-card">
        <h3><span class="material-icons">info</span> Características</h3>
        <ul class="caracteristicas-lista">
          <li>
            <span class="material-icons">aspect_ratio</span>
            <div class="carac-info">
              <span class="carac-label">Dimensiones</span>
              <span class="carac-value">{{ cancha?.largo }}m x {{ cancha?.ancho }}m</span>
            </div>
          </li>
          <li>
            <span class="material-icons">sports_tennis</span>
            <div class="carac-info">
              <span class="carac-label">Superficie</span>
              <span class="carac-value">{{ cancha?.tipo_superficie }}</span>
            </div>
          </li>
          <li>
            <span class="material-icons">group</span>
            <div class="carac-info">
              <span class="carac-label">Capacidad</span>
              <span class="carac-value">10-22 jugadores</span>
            </div>
          </li>
        </ul>
      </div>
    </div>

    <!-- Columna Derecha: Reserva -->

    <div class="reserva-section-main">
      <div class="reserva-card">
        <div class="reserva-header">
          <span class="material-icons">event</span>
          <h2>Reserva tu Horario</h2>
        </div>
        <div class="filtros-reserva-grid">
          <div class="form-group">
            <label for="fecha-reserva">
              <span class="material-icons">calendar_today</span>
              Selecciona la Fecha
            </label>
            <input
              id="fecha-reserva"
              type="date"
              [(ngModel)]="fechaSeleccionada"
              [min]="minDate"
              (change)="calcularTotal()"
              class="input-styled"
            />
          </div>
          <div class="form-group">
            <label for="duracion-reserva">
              <span class="material-icons">schedule</span>
              Duración
            </label>
            <div class="filtro-duracion" [class.activo]="dropdownDuracionAbierto">
              <button type="button" class="btn-dropdown-duracion" [class.activo]="dropdownDuracionAbierto" (click)="toggleDropdownDuracion()">
                <span class="dropdown-current">
                  <i class="fas fa-clock"></i>
                  <span>{{ duracionTexto }}</span>
                </span>
                <i class="fas fa-chevron-down"></i>
              </button>
              @if (dropdownDuracionAbierto) {
                <div class="dropdown-menu-duracion">
                  @for (opcion of opcionesDuracion; track opcion.valor) {
                    <button type="button" class="dropdown-item-duracion" [class.seleccionado]="duracionSeleccionada === opcion.valor" (click)="seleccionarDuracion(opcion)">
                      <i class="fas fa-clock"></i>
                      <span class="opcion-label">{{ opcion.texto }}</span>
                      @if (duracionSeleccionada === opcion.valor) {
                        <i class="fas fa-check check-icon"></i>
                      }
                    </button>
                  }
                </div>
              }
            </div>
          </div>
        </div>

        <div class="horarios-disponibles-section">
          <h3>
            <span class="material-icons">access_time</span>
            Horarios Disponibles
          </h3>
          <div class="horarios-grid">
            <button *ngFor="let h of horariosDisponibles"
                    class="horario-btn"
                    [class.disabled]="h.reservado"
                    [class.selected]="h === horarioSeleccionado"
                    [disabled]="h.reservado"
                    (click)="seleccionarHorario(h)">
              <span class="material-icons">{{ h.reservado ? 'block' : 'check_circle' }}</span>
              {{ h.hora }}
            </button>
          </div>
          <div class="horario-leyenda">
            <div class="leyenda-item">
              <div class="dot disponible"></div>
              <span>Disponible</span>
            </div>
            <div class="leyenda-item">
              <div class="dot reservado"></div>
              <span>Reservado</span>
            </div>
            <div class="leyenda-item">
              <div class="dot seleccionado"></div>
              <span>Seleccionado</span>
            </div>
          </div>
        </div>

        <div class="resumen-reserva">
          <div class="resumen-detalle">
            <div class="resumen-row">
              <span class="resumen-label">Tarifa por hora:</span>
              <span class="resumen-value">${{ cancha?.tarifa | number : '1.2-2' }}</span>
            </div>
            <div class="resumen-row">
              <span class="resumen-label">Duración:</span>
              <span class="resumen-value">{{ duracionSeleccionada }} {{ duracionSeleccionada === 1 ? 'hora' : 'horas' }}</span>
            </div>
            <div class="resumen-row total">
              <span class="resumen-label">Total a pagar:</span>
              <span class="precio-final">${{ totalPagar | number : '1.2-2' }}</span>
            </div>
          </div>
          <button class="btn-confirmar-reserva"
                  [disabled]="!horarioSeleccionado || !fechaSeleccionada"
                  (click)="confirmarReserva()">
            <span class="material-icons">event_available</span>
            Confirmar Reserva
          </button>
        </div>
      </div>
    </div>
  </div>

  <!-- Información Adicional y QR Code -->
  <div class="info-adicional-grid">
    <div class="info-card">
      <div class="info-card-header">
        <span class="material-icons">policy</span>
        <h3>Política de Cancelación</h3>
      </div>
      <p>Cancelaciones permitidas hasta <strong>3 horas antes</strong> sin cargo. Después de ese tiempo, se aplicará un cargo del 50% de la tarifa.</p>
    </div>

    <div class="info-card">
      <div class="info-card-header">
        <span class="material-icons">local_parking</span>
        <h3>Servicios Incluidos</h3>
      </div>
      <ul class="servicios-lista">
        <li><span class="material-icons">checkroom</span> Vestuarios climatizados</li>
        <li><span class="material-icons">shower</span> Duchas con agua caliente</li>
        <li><span class="material-icons">local_parking</span> Parqueo gratuito</li>
      </ul>
    </div>

    <div class="qr-card">
      <div class="qr-header">
        <span class="material-icons">qr_code_2</span>
        <h3>Comparte</h3>
      </div>
      <p>Escanea el código QR</p>
      <div class="qr-container">
        <canvas #qrCanvas></canvas>
      </div>
    </div>
  </div>

  <!-- Sección de Comentarios -->
  <div class="comentarios-section">
    <div class="comentarios-header">
      <span class="material-icons">rate_review</span>
      <h2>Opiniones de Nuestros Clientes</h2>
      <span class="total-reviews">({{ totalRatings || 0 }} opiniones)</span>
    </div>

    <div class="comentarios-resumen">
      <div class="rating-promedio">
        <div class="rating-numero">{{ promedioEstrellas || 0 | number: '1.1-1' }}</div>
        <div class="rating-estrellas">
          @for (star of [1,2,3,4,5]; track star) {
            <i class="fas fa-star" [class.filled]="star <= Math.floor(promedioEstrellas)"></i>
          }
        </div>
        <p class="rating-text">{{ obtenerTextoRating() }}</p>
      </div>
      <div class="rating-distribucion">
        <div class="distribucion-row">
          <span class="estrellas-label">5 <i class="fas fa-star"></i></span>
          <div class="barra-progreso">
            <div class="barra-fill" [style.width.%]="calcularPorcentaje(5)"></div>
          </div>
          <span class="porcentaje">{{ calcularPorcentaje(5) }}%</span>
        </div>
        <div class="distribucion-row">
          <span class="estrellas-label">4 <i class="fas fa-star"></i></span>
          <div class="barra-progreso">
            <div class="barra-fill" [style.width.%]="calcularPorcentaje(4)"></div>
          </div>
          <span class="porcentaje">{{ calcularPorcentaje(4) }}%</span>
        </div>
        <div class="distribucion-row">
          <span class="estrellas-label">3 <i class="fas fa-star"></i></span>
          <div class="barra-progreso">
            <div class="barra-fill" [style.width.%]="calcularPorcentaje(3)"></div>
          </div>
          <span class="porcentaje">{{ calcularPorcentaje(3) }}%</span>
        </div>
        <div class="distribucion-row">
          <span class="estrellas-label">2 <i class="fas fa-star"></i></span>
          <div class="barra-progreso">
            <div class="barra-fill" [style.width.%]="calcularPorcentaje(2)"></div>
          </div>
          <span class="porcentaje">{{ calcularPorcentaje(2) }}%</span>
        </div>
        <div class="distribucion-row">
          <span class="estrellas-label">1 <i class="fas fa-star"></i></span>
          <div class="barra-progreso">
            <div class="barra-fill" [style.width.%]="calcularPorcentaje(1)"></div>
          </div>
          <span class="porcentaje">{{ calcularPorcentaje(1) }}%</span>
        </div>
      </div>
    </div>

    @if (comentarios.length > 0) {
      <div class="comentarios-grid">
        @for (comentario of comentarios; track comentario.id_rating) {
          <div class="comentario-card">
            <div class="comentario-header">
              <div class="usuario-avatar">{{ comentario.iniciales }}</div>
              <div class="usuario-info">
                <strong>{{ comentario.nombre }}</strong>
                <div class="rating-stars">
                  @for (star of [1,2,3,4,5]; track star) {
                    <i class="fas fa-star" [class.filled]="star <= comentario.estrellas"></i>
                  }
                </div>
                <small>{{ comentario.fecha }}</small>
              </div>
              @if (puedeEditarComentario(comentario)) {
                <button class="btn-editar-comentario" (click)="abrirModalEdicion(comentario)" title="Editar mi reseña">
                  <span class="material-icons">edit</span>
                </button>
              }
            </div>
            <div class="comentario-content">
              <p>{{ comentario.comentario }}</p>
            </div>
          </div>
        }
      </div>

      <button class="btn-ver-mas-comentarios">
        <span class="material-icons">expand_more</span>
        Ver más opiniones
      </button>
    } @else {
      <div class="sin-comentarios">
        <div class="sin-comentarios-icon">
          <span class="material-icons">chat_bubble_outline</span>
        </div>
        <h3>Aún no hay reseñas para esta cancha</h3>
        <p>Sé el primero en compartir tu experiencia y ayudar a otros usuarios a conocer este espacio deportivo.</p>
        <button class="btn-primer-comentario" (click)="abrirModalRating()">
          <span class="material-icons">rate_review</span>
          Dejar mi opinión
        </button>
      </div>
    }
  </div>

</div>

<!-- Modal para dejar reseña -->
@if (mostrarModalRating) {
  <div class="modal-overlay">
    <div class="modal-content">
      <div class="modal-header">
        <h2>
          @if (!modoEdicion) {
            <span class="material-icons">rate_review</span>
          }
          {{ modoEdicion ? 'Editar reseña' : 'Deja tu reseña' }}
        </h2>
        <button class="btn-close-modal" (click)="cerrarModalRating()">
          <span class="material-icons">close</span>
        </button>
      </div>

      <div class="modal-body">
        <div class="cancha-info-modal">
          <h3>{{ cancha?.nombre_cancha }}</h3>
        </div>

        <div class="rating-selector">
          <label>Tu calificación *</label>
          <div class="estrellas-selector">
            @for (star of [1,2,3,4,5]; track star) {
              <i
                class="fas fa-star"
                [class.filled]="star <= nuevaCalificacion"
                (click)="seleccionarEstrellas(star)"
                style="cursor: pointer; font-size: 2rem; margin: 0 0.3rem;">
              </i>
            }
          </div>
          @if (nuevaCalificacion > 0) {
            <p class="rating-text-modal">
              {{ nuevaCalificacion === 5 ? 'Excelente' :
                 nuevaCalificacion === 4 ? 'Muy bueno' :
                 nuevaCalificacion === 3 ? 'Bueno' :
                 nuevaCalificacion === 2 ? 'Regular' : 'Malo' }}
            </p>
          }
        </div>

        <div class="comentario-input">
          <label>Tu comentario (opcional)</label>
          <textarea
            [(ngModel)]="nuevoComentario"
            placeholder="Comparte tu experiencia con esta cancha..."
            rows="4"
            maxlength="500">
          </textarea>
          <small>{{ nuevoComentario.length }}/500 caracteres</small>
        </div>
      </div>

      <div class="modal-footer">
        <button class="btn-cancelar" (click)="cerrarModalRating()" [disabled]="enviandoRating">
          Cancelar
        </button>
        <button class="btn-enviar" (click)="enviarRating()" [disabled]="enviandoRating || nuevaCalificacion === 0">
          @if (enviandoRating) {
            <span>{{ modoEdicion ? 'Actualizando...' : 'Enviando...' }}</span>
          } @else {
            <span class="material-icons">{{ modoEdicion ? 'save' : 'send' }}</span>
            <span>{{ modoEdicion ? 'Guardar cambios' : 'Enviar reseña' }}</span>
          }
        </button>
      </div>
    </div>
  </div>
}
