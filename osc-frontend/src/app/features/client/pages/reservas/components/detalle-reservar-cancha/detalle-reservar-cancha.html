<div class="detalle-cancha-container">

  @if (cargando) {
    <!-- Skeleton Loading -->
    <div class="detalle-skeleton">
      <div class="skeleton-breadcrumb"></div>

      <div class="skeleton-header">
        <div class="skeleton-header-left">
          <div class="skeleton-title"></div>
          <div class="skeleton-meta"></div>
        </div>
        <div class="skeleton-price"></div>
      </div>

      <div class="skeleton-content-grid">
        <div class="skeleton-image"></div>
        <div class="skeleton-card">
          <div class="skeleton-card-header"></div>
          <div class="skeleton-line"></div>
          <div class="skeleton-line"></div>
          <div class="skeleton-line"></div>
        </div>
      </div>
    </div>
  } @else {

  <!-- Breadcrumb -->
  <nav class="breadcrumb">
    <a routerLink="/reservar-cancha">
      <span class="material-icons">arrow_back</span>
      Volver a Canchas
    </a>
    <span class="breadcrumb-separator">/</span>
    <span class="current">{{ cancha?.nombre_cancha }}</span>
  </nav>

  <!-- Header de la Cancha -->
  <div class="cancha-header-main">
    <div class="header-left">
      <h1 class="cancha-titulo">{{ cancha?.nombre_cancha }}</h1>
      <div class="cancha-meta">
        <div class="rating-display">
          <i class="fas fa-star"></i>
          <span class="rating-value">{{ promedioEstrellas || 0 | number: '1.1-1' }}</span>
          <span class="reviews-count">({{ totalRatings || 0 }} opiniones)</span>
        </div>
        <div class="sede-info">
          <span class="material-icons">location_on</span>
          <span>{{ sede?.nombre_sede }}</span>
        </div>
      </div>
    </div>
    <div class="header-right">
      <div class="precio-destacado">
        <span class="precio-label">Desde</span>
        <span class="precio-valor">${{ cancha?.tarifa | number : '1.2-2' }}</span>
        <span class="precio-unidad">/hora</span>
      </div>
    </div>
  </div>

  <!-- Layout Principal: Imagen + Info -->
  <div class="main-content-grid">

    <!-- Columna Izquierda: Imagen -->
    <div class="imagen-section">
      <div class="imagen-principal">
        <img
          [src]="cancha?.imagen_url || 'https://via.placeholder.com/640x320?text=Sin+Imagen'"
          [alt]="cancha?.nombre_cancha">
        <div class="badges">
          <span class="badge tipo-cancha">
            <span class="material-icons">grass</span>
            {{ cancha?.tipo_superficie }}
          </span>
          <span class="badge estado" [attr.data-estado]="cancha?.estado">
            <span class="material-icons">check_circle</span>
            {{ cancha?.estado }}
          </span>
        </div>
      </div>

      <!-- Características de la Cancha -->
      <div class="caracteristicas-card">
        <h3><span class="material-icons">info</span> Características</h3>
        <ul class="caracteristicas-lista">
          <li>
            <span class="material-icons">aspect_ratio</span>
            <div class="carac-info">
              <span class="carac-label">Dimensiones</span>
              <span class="carac-value">{{ cancha?.largo }}m x {{ cancha?.ancho }}m</span>
            </div>
          </li>
          <li>
            <span class="material-icons">sports_tennis</span>
            <div class="carac-info">
              <span class="carac-label">Superficie</span>
              <span class="carac-value">{{ cancha?.tipo_superficie }}</span>
            </div>
          </li>
          <li>
            <span class="material-icons">group</span>
            <div class="carac-info">
              <span class="carac-label">Capacidad</span>
              <span class="carac-value">10-22 jugadores</span>
            </div>
          </li>
        </ul>
      </div>
    </div>

    <!-- Columna Derecha: Reserva -->

    <div class="reserva-section-main">
      <div class="reserva-card">
        <div class="reserva-header">
          <span class="material-icons">event</span>
          <h2>Reserva tu Horario</h2>
        </div>

        <!-- Mostrar fecha calculada automáticamente -->
        @if (fechaSeleccionada) {
          <div class="fecha-calculada-banner">
            <span class="material-icons">event</span>
            <div class="fecha-info">
              <span class="fecha-label">Fecha de reserva:</span>
              <span class="fecha-valor">{{ obtenerTextoFecha() }}</span>
            </div>
          </div>
        }

        <div class="filtros-reserva-grid">
          <div class="form-group">
            <label for="dia-reserva">
              <span class="material-icons">today</span>
              Día de la Semana
            </label>
            <div class="filtro-duracion" [class.activo]="dropdownDiasAbierto">
              <button type="button" class="btn-dropdown-duracion" [class.activo]="dropdownDiasAbierto" (click)="toggleDropdownDias()">
                <span class="dropdown-current">
                  <i class="fas fa-calendar-day"></i>
                  <span>{{ diaTexto }}</span>
                </span>
                <i class="fas fa-chevron-down"></i>
              </button>
              @if (dropdownDiasAbierto) {
                <div class="dropdown-menu-duracion">
                  @for (opcion of diasDisponibles; track opcion.valor) {
                    <button type="button" class="dropdown-item-duracion" [class.seleccionado]="diaSeleccionado === opcion.valor" (click)="seleccionarDia(opcion)">
                      <i class="fas fa-calendar-day"></i>
                      <span class="opcion-label">{{ opcion.texto }}</span>
                      @if (diaSeleccionado === opcion.valor) {
                        <i class="fas fa-check check-icon"></i>
                      }
                    </button>
                  }
                </div>
              }
            </div>
          </div>
        </div>

        <div class="horarios-disponibles-section">
          <h3>
            <span class="material-icons">access_time</span>
            Horarios Disponibles
          </h3>
          @if (diaSeleccionado !== null && horariosDelDia.length > 0) {
            <div class="horarios-grid">
              <button *ngFor="let h of horariosDelDia"
                      class="horario-btn"
                      [class.disabled]="h.reservado"
                      [class.selected]="h === horarioSeleccionado"
                      [disabled]="h.reservado"
                      (click)="seleccionarHorario(h)">
                <span class="material-icons">{{ h.reservado ? 'block' : 'check_circle' }}</span>
                {{ h.hora_inicio }} - {{ h.hora_fin }}
              </button>
            </div>
          } @else {
            <div class="sin-horarios">
              <span class="material-icons">event_busy</span>
              <p>Selecciona un día para ver los horarios disponibles</p>
            </div>
          }
          <div class="horario-leyenda">
            <div class="leyenda-item">
              <div class="dot disponible"></div>
              <span>Disponible</span>
            </div>
            <div class="leyenda-item">
              <div class="dot reservado"></div>
              <span>Reservado</span>
            </div>
            <div class="leyenda-item">
              <div class="dot seleccionado"></div>
              <span>Seleccionado</span>
            </div>
          </div>
        </div>

        <!-- Selector de Tipo de Pago -->
        <div class="tipo-pago-section">
          <h3>
            <span class="material-icons">payment</span>
            Método de Pago
          </h3>
          <div class="tipo-pago-opciones">
            <label class="tipo-pago-item" [class.seleccionado]="tipoPagoSeleccionado === 'efectivo'">
              <input type="radio" name="tipoPago" value="efectivo" [(ngModel)]="tipoPagoSeleccionado" (change)="cambiarTipoPago('efectivo')">
              <div class="tipo-pago-contenido">
                <i class="fas fa-money-bill-wave"></i>
                <span>Pago en Efectivo</span>
                <small>Paga directamente en la sede</small>
              </div>
            </label>
            <label class="tipo-pago-item" [class.seleccionado]="tipoPagoSeleccionado === 'virtual'">
              <input type="radio" name="tipoPago" value="virtual" [(ngModel)]="tipoPagoSeleccionado" (change)="cambiarTipoPago('virtual')">
              <div class="tipo-pago-contenido">
                <i class="fas fa-credit-card"></i>
                <span>Pago Virtual</span>
                <small>Paga con tarjeta ahora</small>
              </div>
            </label>
          </div>

          <!-- Selector de Método de Pago (solo si es virtual) -->
          @if (tipoPagoSeleccionado === 'virtual') {
            <div class="metodos-pago-selector">
              @if (cargandoMetodosPago) {
                <div class="cargando-metodos">
                  <i class="fas fa-spinner fa-spin"></i>
                  <span>Cargando métodos de pago...</span>
                </div>
              } @else if (metodosPago.length === 0) {
                <div class="sin-metodos">
                  <i class="fas fa-exclamation-circle"></i>
                  <p>No tienes métodos de pago registrados</p>
                  <a [routerLink]="['/client/profile/metodos-pago']" class="btn-agregar-metodo">
                    <i class="fas fa-plus"></i>
                    Agregar Método de Pago
                  </a>
                </div>
              } @else {
                <div class="form-group">
                  <label for="metodo-pago">
                    <span class="material-icons">credit_card</span>
                    Selecciona tu tarjeta
                  </label>
                  <select id="metodo-pago" class="select-metodo-pago" [(ngModel)]="metodoPagoSeleccionado">
                    <option [value]="null">-- Selecciona una tarjeta --</option>
                    @for (metodo of metodosPago; track metodo.id_metodo_pago) {
                      <option [value]="metodo.id_metodo_pago">
                        {{ metodo.banco }} - {{ metodo.tipo_tarjeta }} {{ metodo.numero_tarjeta }}
                      </option>
                    }
                  </select>
                </div>
              }
            </div>
          }
        </div>

        <div class="resumen-reserva">
          <div class="resumen-detalle">
            <div class="resumen-row">
              <span class="resumen-label">Tarifa por hora:</span>
              <span class="resumen-value">${{ cancha?.tarifa | number : '1.2-2' }}</span>
            </div>
            <div class="resumen-row">
              <span class="resumen-label">Duración:</span>
              <span class="resumen-value">1 hora</span>
            </div>
            <div class="resumen-row total">
              <span class="resumen-label">Total a pagar:</span>
              <span class="precio-final">${{ totalPagar | number : '1.2-2' }}</span>
            </div>
          </div>
          <button class="btn-confirmar-reserva"
                  [disabled]="!horarioSeleccionado || !fechaSeleccionada || diaSeleccionado === null || (tipoPagoSeleccionado === 'virtual' && !metodoPagoSeleccionado)"
                  (click)="confirmarReserva()">
            <span class="material-icons">event_available</span>
            Confirmar Reserva
          </button>
        </div>
      </div>
    </div>
  </div>

  <!-- Información Adicional y QR Code -->
  <div class="info-adicional-grid">
    <div class="info-card">
      <div class="info-card-header">
        <span class="material-icons">policy</span>
        <h3>Política de Cancelación</h3>
      </div>
      <p>Cancelaciones permitidas hasta <strong>3 horas antes</strong> sin cargo. Después de ese tiempo, se aplicará un cargo del 50% de la tarifa.</p>
    </div>

    <div class="info-card">
      <div class="info-card-header">
        <span class="material-icons">local_parking</span>
        <h3>Servicios Incluidos</h3>
      </div>
      <ul class="servicios-lista">
        <li><span class="material-icons">checkroom</span> Vestuarios climatizados</li>
        <li><span class="material-icons">shower</span> Duchas con agua caliente</li>
        <li><span class="material-icons">local_parking</span> Parqueo gratuito</li>
      </ul>
    </div>

    <div class="qr-card">
      <div class="qr-header">
        <span class="material-icons">qr_code_2</span>
        <h3>Comparte</h3>
      </div>
      <p>Escanea el código QR</p>
      <div class="qr-container">
        <canvas #qrCanvas></canvas>
      </div>
    </div>
  </div>

  <!-- Sección de Comentarios -->
  <div class="comentarios-section">
    <div class="comentarios-header">
      <span class="material-icons">rate_review</span>
      <h2>Opiniones de Nuestros Clientes</h2>
      <span class="total-reviews">({{ totalRatings || 0 }} opiniones)</span>
    </div>

    <div class="comentarios-resumen">
      <div class="rating-promedio">
        <div class="rating-numero">{{ promedioEstrellas || 0 | number: '1.1-1' }}</div>
        <div class="rating-estrellas">
          @for (star of [1,2,3,4,5]; track star) {
            <i class="fas fa-star" [class.filled]="star <= Math.floor(promedioEstrellas)"></i>
          }
        </div>
        <p class="rating-text">{{ obtenerTextoRating() }}</p>
      </div>
      <div class="rating-distribucion">
        <div class="distribucion-row">
          <span class="estrellas-label">5 <i class="fas fa-star"></i></span>
          <div class="barra-progreso">
            <div class="barra-fill" [style.width.%]="calcularPorcentaje(5)"></div>
          </div>
          <span class="porcentaje">{{ calcularPorcentaje(5) }}%</span>
        </div>
        <div class="distribucion-row">
          <span class="estrellas-label">4 <i class="fas fa-star"></i></span>
          <div class="barra-progreso">
            <div class="barra-fill" [style.width.%]="calcularPorcentaje(4)"></div>
          </div>
          <span class="porcentaje">{{ calcularPorcentaje(4) }}%</span>
        </div>
        <div class="distribucion-row">
          <span class="estrellas-label">3 <i class="fas fa-star"></i></span>
          <div class="barra-progreso">
            <div class="barra-fill" [style.width.%]="calcularPorcentaje(3)"></div>
          </div>
          <span class="porcentaje">{{ calcularPorcentaje(3) }}%</span>
        </div>
        <div class="distribucion-row">
          <span class="estrellas-label">2 <i class="fas fa-star"></i></span>
          <div class="barra-progreso">
            <div class="barra-fill" [style.width.%]="calcularPorcentaje(2)"></div>
          </div>
          <span class="porcentaje">{{ calcularPorcentaje(2) }}%</span>
        </div>
        <div class="distribucion-row">
          <span class="estrellas-label">1 <i class="fas fa-star"></i></span>
          <div class="barra-progreso">
            <div class="barra-fill" [style.width.%]="calcularPorcentaje(1)"></div>
          </div>
          <span class="porcentaje">{{ calcularPorcentaje(1) }}%</span>
        </div>
      </div>
    </div>

    @if (comentarios.length > 0) {
      <div class="comentarios-grid">
        @for (comentario of comentarios; track comentario.id_rating) {
          <div class="comentario-card">
            <div class="comentario-header">
              <div class="usuario-avatar">{{ comentario.iniciales }}</div>
              <div class="usuario-info">
                <strong>{{ comentario.nombre }}</strong>
                <div class="rating-stars">
                  @for (star of [1,2,3,4,5]; track star) {
                    <i class="fas fa-star" [class.filled]="star <= comentario.estrellas"></i>
                  }
                </div>
                <small>{{ comentario.fecha }}</small>
              </div>
              @if (puedeEditarComentario(comentario)) {
                <div class="comentario-acciones">
                  <button class="btn-accion-comentario btn-editar" (click)="abrirModalEdicion(comentario)" title="Editar mi reseña">
                    <span class="material-icons">edit</span>
                  </button>
                  <button class="btn-accion-comentario btn-eliminar" (click)="eliminarComentario(comentario)" title="Eliminar mi reseña">
                    <span class="material-icons">delete</span>
                  </button>
                </div>
              }
            </div>
            <div class="comentario-content">
              <p>{{ comentario.comentario }}</p>
            </div>
          </div>
        }
      </div>

      @if (comentarios.length > 4) {
        <button class="btn-ver-mas-comentarios">
          <span class="material-icons">expand_more</span>
          Ver más opiniones
        </button>
      }
    } @else {
      <div class="sin-comentarios">
        <div class="sin-comentarios-icon">
          <span class="material-icons">chat_bubble_outline</span>
        </div>
        <h3>Aún no hay reseñas para esta cancha</h3>
        <p>Sé el primero en compartir tu experiencia y ayudar a otros usuarios a conocer este espacio deportivo.</p>
        <button class="btn-primer-comentario" (click)="abrirModalRating()">
          <span class="material-icons">rate_review</span>
          Dejar mi opinión
        </button>
      </div>
    }
  </div>

  <!-- Modal para dejar reseña -->
  @if (mostrarModalRating) {
  <div class="modal-overlay">
    <div class="modal-content">
      <div class="modal-header">
        <h2>
          @if (!modoEdicion) {
            <span class="material-icons">rate_review</span>
          }
          {{ modoEdicion ? 'Editar reseña' : 'Deja tu reseña' }}
        </h2>
        <button class="btn-close-modal" (click)="cerrarModalRating()">
          <span class="material-icons">close</span>
        </button>
      </div>

      <div class="modal-body">
        <div class="cancha-info-modal">
          <h3>{{ cancha?.nombre_cancha }}</h3>
        </div>

        <div class="rating-selector">
          <label>Tu calificación *</label>
          <div class="estrellas-selector">
            @for (star of [1,2,3,4,5]; track star) {
              <i
                class="fas fa-star"
                [class.filled]="star <= nuevaCalificacion"
                (click)="seleccionarEstrellas(star)"
                style="cursor: pointer; font-size: 2rem; margin: 0 0.3rem;">
              </i>
            }
          </div>
          @if (nuevaCalificacion > 0) {
            <p class="rating-text-modal">
              {{ nuevaCalificacion === 5 ? 'Excelente' :
                 nuevaCalificacion === 4 ? 'Muy bueno' :
                 nuevaCalificacion === 3 ? 'Bueno' :
                 nuevaCalificacion === 2 ? 'Regular' : 'Malo' }}
            </p>
          }
        </div>

        <div class="comentario-input">
          <label>Tu comentario (opcional)</label>
          <textarea
            [(ngModel)]="nuevoComentario"
            placeholder="Comparte tu experiencia con esta cancha..."
            rows="4"
            maxlength="500">
          </textarea>
          <small>{{ nuevoComentario.length }}/500 caracteres</small>
        </div>
      </div>

      <div class="modal-footer">
        <button class="btn-cancelar" (click)="cerrarModalRating()" [disabled]="enviandoRating">
          Cancelar
        </button>
        <button class="btn-enviar" (click)="enviarRating()" [disabled]="enviandoRating || nuevaCalificacion === 0">
          @if (enviandoRating) {
            <span>{{ modoEdicion ? 'Actualizando...' : 'Enviando...' }}</span>
          } @else {
            <span class="material-icons">{{ modoEdicion ? 'save' : 'send' }}</span>
            <span>{{ modoEdicion ? 'Guardar cambios' : 'Enviar reseña' }}</span>
          }
        </button>
      </div>
    </div>
  </div>
  }

  }
</div>
