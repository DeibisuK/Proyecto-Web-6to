<div class="equipos-container">
  <!-- Header -->
  <div class="equipos-header">
    <div class="header-info">
      <h1>Mis Equipos</h1>
      <p>Administra y organiza tus equipos deportivos</p>
    </div>
    <button class="btn-crear" (click)="abrirModalCrear()">
      <span class="material-icons">add</span>
      Crear Equipo
    </button>
  </div>

  <!-- Buscador y Filtros -->
  <div class="search-section">
    <div class="search-box">
      <span class="material-icons">search</span>
      <input
        type="text"
        placeholder="Buscar equipos por nombre..."
        [(ngModel)]="searchTerm"
        (input)="filtrarEquipos()"
      />
    </div>
    <div class="stats">
      <span class="stat-badge">
        <span class="material-icons">groups</span>
        {{ equiposFiltrados.length }} Equipos
      </span>
    </div>
  </div>

  <!-- Lista de Equipos -->
  @if (!isLoading && equiposFiltrados.length > 0) {
    <div class="equipos-grid">
      @for (equipo of equiposFiltrados; track equipo.id_equipo) {
        <div class="equipo-card">
          <div class="equipo-card-body">
            <div class="equipo-logo">
              @if (equipo.logo_url) {
                <picture>
                  <source [srcset]="toAVIF(equipo.logo_url)" type="image/avif">
                  <source [srcset]="toWebP(equipo.logo_url)" type="image/webp">
                  <img
                    [src]="equipo.logo_url"
                    [alt]="equipo.nombre_equipo"
                    loading="lazy"
                  />
                </picture>
              } @else {
                <div class="logo-fallback">
                  <span class="material-icons">shield</span>
                </div>
              }
            </div>

            <div class="equipo-info">
              <h3>{{ equipo.nombre_equipo }}</h3>
              <p class="descripcion">{{ equipo.descripcion || 'Sin descripción' }}</p>
            </div>

            <div class="equipo-actions">
              <button
                class="btn-action btn-assign"
                (click)="abrirModalAsignar(equipo)"
                title="Asignar usuarios"
              >
                <span class="material-icons">group_add</span>
              </button>
              <button
                class="btn-action btn-edit"
                (click)="editarEquipo(equipo)"
                title="Editar equipo"
              >
                <span class="material-icons">edit</span>
              </button>
              <button
                class="btn-action btn-delete"
                (click)="eliminarEquipo(equipo)"
                title="Eliminar equipo"
              >
                <span class="material-icons">delete</span>
              </button>
            </div>
          </div>

          <!-- Footer con el deporte -->
          <div class="equipo-footer">
            @if (equipo.id_deporte) {
              <span class="deporte-badge" [attr.data-deporte]="equipo.id_deporte">
                <span class="material-icons">sports_soccer</span>
                {{ obtenerNombreDeporte(equipo.id_deporte) }}
              </span>
            }
          </div>
        </div>
      }
    </div>
  }

  <!-- Skeleton Loading -->
  @if (isLoading) {
    <div class="equipos-grid">
      @for (item of [1,2,3,4,5,6]; track item) {
        <div class="equipo-card skeleton">
        <div class="equipo-logo skeleton-logo">
          <div class="skeleton-shimmer"></div>
        </div>
        <div class="equipo-info">
          <div class="skeleton-text skeleton-title"></div>
          <div class="skeleton-text skeleton-badge" style="width: 30%;"></div>
          <div class="skeleton-text skeleton-detail"></div>
          <div class="skeleton-text skeleton-detail" style="width: 70%;"></div>
        </div>
        <div class="equipo-actions">
          <div class="skeleton-button"></div>
          <div class="skeleton-button"></div>
        </div>
        </div>
      }
    </div>
  }

  <!-- Sin equipos -->
  @if (!isLoading && equiposFiltrados.length === 0) {
    <div class="empty-state">
      <div class="empty-icon">
        <span class="material-icons">sports_soccer</span>
      </div>
      <h3>No tienes equipos registrados</h3>
      <p>Crea tu primer equipo para empezar a organizar tus partidos</p>
    </div>
  }
</div>

<!-- Modal de Crear/Editar Equipo -->
@if (mostrarModal) {
  <div class="modal-overlay" (click)="cerrarModal()">
    <div class="modal-content" (click)="$event.stopPropagation()">
      <app-crear-equipo
        [equipoEditar]="equipoSeleccionado"
        (equipoGuardado)="onEquipoGuardado($event)"
        (cerrarModal)="cerrarModal()"
      ></app-crear-equipo>
    </div>
  </div>
}

<!-- Modal de Confirmación de Eliminación -->
@if (mostrarModalEliminar) {
  <div class="modal-overlay" (click)="cerrarModalEliminar()">
    <div class="modal-confirm" (click)="$event.stopPropagation()">
    <div class="confirm-header">
      <span class="material-icons danger">warning</span>
      <h3>¿Eliminar Equipo?</h3>
    </div>
    <p>¿Estás seguro de que deseas eliminar el equipo <strong>{{ equipoAEliminar?.nombre_equipo }}</strong>?</p>
    <p class="confirm-warning">Esta acción no se puede deshacer.</p>
    <div class="confirm-actions">
      <button class="btn btn-secondary" (click)="cerrarModalEliminar()">
        Cancelar
      </button>
      <button class="btn btn-danger" (click)="confirmarEliminacion()">
        <span class="material-icons">delete</span>
        Eliminar
      </button>
    </div>
  </div>
  </div>
}

<!-- Modal de Asignar Usuarios -->
@if (mostrarModalAsignar) {
  <div class="modal-overlay" (click)="cerrarModalAsignar()">
    <div class="modal-asignar" (click)="$event.stopPropagation()">
      <div class="modal-header">
        <div class="header-title">
          <span class="material-icons">group_add</span>
          <h3>Asignar Usuarios - {{ equipoParaAsignar?.nombre_equipo }}</h3>
        </div>
        <button class="btn-close" (click)="cerrarModalAsignar()">
          <span class="material-icons">close</span>
        </button>
      </div>

      <div class="modal-body-asignar">
        <!-- Panel de Usuarios Disponibles -->
        <div class="usuarios-panel">
          <div class="panel-header">
            <h4>
              <span class="material-icons">person_search</span>
              Usuarios Disponibles
            </h4>
            <span class="count-badge">{{ usuariosDisponibles.length }}</span>
          </div>

          <div class="search-usuarios">
            <span class="material-icons">search</span>
            <input
              type="text"
              placeholder="Buscar usuarios..."
              [(ngModel)]="searchUsuario"
              (input)="filtrarUsuariosDisponibles()"
            />
          </div>

          @if (isLoadingUsuarios) {
            <div class="loading-usuarios">
              <span class="spinner"></span>
              <p>Cargando usuarios...</p>
            </div>
          } @else if (usuariosFiltrados.length > 0) {
            <div class="usuarios-list">
              @for (usuario of usuariosFiltrados; track usuario.id) {
                <div class="usuario-item" [class.no-disponible]="usuario.noDisponible">
                  <div class="usuario-info">
                    <span class="material-icons">person</span>
                    <div class="info-text">
                      <span class="nombre">{{ usuario.nombre }}</span>
                      <span class="email">{{ usuario.email }}</span>
                      @if (usuario.noDisponible) {
                        <span class="badge-conflicto">
                          <span class="material-icons">warning</span>
                          Ya está en {{ usuario.equipoActual }} (mismo deporte)
                        </span>
                      }
                    </div>
                  </div>
                  <button
                    class="btn-add"
                    [disabled]="usuario.noDisponible"
                    (click)="asignarUsuario(usuario)"
                    [title]="usuario.noDisponible ? 'Este usuario ya está en un equipo del mismo deporte' : 'Agregar al equipo'"
                  >
                    <span class="material-icons">add_circle</span>
                  </button>
                </div>
              }
            </div>
          } @else {
            <div class="empty-panel">
              <span class="material-icons">
                {{ searchUsuario ? 'search_off' : 'inbox' }}
              </span>
              <p>{{ searchUsuario ? 'No se encontraron usuarios' : 'No hay usuarios disponibles' }}</p>
            </div>
          }
        </div>

        <!-- Panel de Usuarios del Equipo -->
        <div class="usuarios-panel">
          <div class="panel-header">
            <h4>
              <span class="material-icons">groups</span>
              Miembros del Equipo
            </h4>
            <span class="count-badge">{{ usuariosEquipo.length }}</span>
          </div>

          <div class="equipo-info-header">
            @if (equipoParaAsignar?.logo_url) {
              <picture>
                <source [srcset]="toAVIF(equipoParaAsignar?.logo_url)" type="image/avif">
                <source [srcset]="toWebP(equipoParaAsignar?.logo_url)" type="image/webp">
                <img class="equipo-mini-logo" [src]="equipoParaAsignar!.logo_url" [alt]="equipoParaAsignar!.nombre_equipo" loading="lazy" />
              </picture>
            } @else {
              <div class="equipo-mini-logo-placeholder">
                <span class="material-icons">shield</span>
              </div>
            }
            <div>
              <h5>{{ equipoParaAsignar?.nombre_equipo }}</h5>
              @if (equipoParaAsignar?.id_deporte) {
                <span class="deporte-mini-badge" [attr.data-deporte]="equipoParaAsignar!.id_deporte">
                  {{ obtenerNombreDeporte(equipoParaAsignar!.id_deporte) }}
                </span>
              }
            </div>
          </div>

          @if (usuariosEquipo.length > 0) {
            <div class="usuarios-list">
              @for (usuario of usuariosEquipo; track usuario.id_jugador || usuario.id; let i = $index) {
                <div class="usuario-item assigned">
                  <div class="usuario-full-info">
                    <!-- Cabecera con nombre y botón remover -->
                    <div class="usuario-header">
                      <div class="usuario-basic">
                        @if (usuario.numero_dorsal) {
                          <div class="jersey-number">{{ usuario.numero_dorsal }}</div>
                        } @else {
                          <span class="material-icons">person</span>
                        }
                        <div class="info-text">
                          <span class="nombre">
                            {{ usuario.nombre }}
                            @if (usuario.es_capitan) {
                              <span class="capitan-badge" title="Capitán">
                                <span class="material-icons">star</span>
                              </span>
                            }
                          </span>
                          <span class="email">{{ usuario.email }}</span>
                        </div>
                      </div>
                      <button
                        class="btn-remove"
                        (click)="removerUsuario(usuario)"
                        title="Remover del equipo"
                      >
                        <span class="material-icons">remove_circle</span>
                      </button>
                    </div>

                    <!-- Formulario de datos del jugador -->
                    <div class="jugador-form">
                      <div class="form-group">
                        <label for="dorsal-{{i}}">
                          <span class="material-icons">tag</span>
                          Dorsal
                        </label>
                        <input
                          type="number"
                          id="dorsal-{{i}}"
                          [(ngModel)]="usuario.numero_dorsal"
                          min="0"
                          max="99"
                          placeholder="Ej: 10"
                        />
                      </div>

                      <div class="form-group">
                        <label for="posicion-{{i}}">
                          <span class="material-icons">sports</span>
                          Posición
                        </label>
                        <input
                          type="text"
                          id="posicion-{{i}}"
                          [(ngModel)]="usuario.posicion"
                          placeholder="Ej: Delantero"
                          [attr.list]="'posiciones-' + (equipoParaAsignar?.id_deporte || 0)"
                        />
                        <datalist [id]="'posiciones-' + (equipoParaAsignar?.id_deporte || 0)">
                          @for (pos of obtenerPosicionesDeporte(equipoParaAsignar?.id_deporte); track pos) {
                            <option [value]="pos">{{ pos }}</option>
                          }
                        </datalist>
                      </div>

                      <div class="form-group checkbox-group">
                        <label for="capitan-{{i}}" class="checkbox-label">
                          <input
                            type="checkbox"
                            id="capitan-{{i}}"
                            [(ngModel)]="usuario.es_capitan"
                            (change)="manejarCambioCapitan(usuario)"
                          />
                          <span class="material-icons">star</span>
                          <span>Capitán</span>
                        </label>
                      </div>
                    </div>
                  </div>
                </div>
              }
            </div>
          } @else {
            <div class="empty-panel">
              <span class="material-icons">group_off</span>
              <p>No hay miembros asignados</p>
            </div>
          }
        </div>
      </div>

      <div class="modal-footer">
        <button class="btn btn-secondary" (click)="cerrarModalAsignar()">
          Cancelar
        </button>
        <button class="btn btn-primary" (click)="guardarAsignaciones()">
          <span class="material-icons">save</span>
          Guardar Asignaciones
        </button>
      </div>
    </div>
  </div>
}
