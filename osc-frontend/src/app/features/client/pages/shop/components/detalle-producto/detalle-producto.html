@if (producto() && varianteSeleccionada()) {
<div class="detalle-producto-container">
  <!-- Breadcrumb -->
  <nav class="breadcrumb">
    <a routerLink="/tienda">Tienda</a>
    <span class="breadcrumb-separator">/</span>
    <span class="current">{{ producto()!.nombre }}</span>
  </nav>

  <div class="producto-content">
    <!-- Secci√≥n de Imagen -->
    <div class="imagen-section">
      <div class="imagen-principal">
        <img [src]="imagenPrincipal()" [alt]="producto()!.nombre" (error)="onImageError($event)" />
        <div class="badges">
          @if (producto()!.es_nuevo) {
            <span class="badge nuevo">Nuevo</span>
          }
        </div>
      </div>
      <div class="imagenes-secundarias">
        @for (imagen of imagenesNormalizadas(); track $index) {
          <div
            class="imagen-miniatura"
            [class.active]="imagenPrincipal() === imagen"
            (click)="cambiarImagenPrincipal(imagen)"
          >
            <img
              [src]="imagen"
              [alt]="producto()!.nombre + ' - ' + ($index + 1)"
              (error)="onImageError($event)"
            />
          </div>
        }
        <!-- Placeholders si hay menos de 4 im√°genes -->
        @for (i of [1, 2, 3, 4].slice(imagenesNormalizadas().length); track i) {
          <div class="imagen-miniatura placeholder">
            <i class="fas fa-image"></i>
          </div>
        }
      </div>
    </div>

    <!-- Secci√≥n de Informaci√≥n -->
    <div class="info-section">
      <!-- Header del producto -->
      <div class="producto-header">
        <h1 class="producto-titulo">{{ producto()!.nombre }}</h1>
        <div class="marca-categoria">
          <span class="marca">{{ producto()!.nombre_marca }}</span>
          <span class="categoria">{{ categoriaDisplay() }}</span>
        </div>
      </div>

      <!-- Precio -->
      <div class="precio-section">
        <div class="precio-info">
          <span class="precio-label">Precio:</span>
          <div class="precios">
            <span class="precio-actual">${{ varianteSeleccionada()!.precio | number : '1.2-2' }}</span>
            @if (
              varianteSeleccionada()!.precio_anterior &&
              varianteSeleccionada()!.precio_anterior! > varianteSeleccionada()!.precio
            ) {
              <span class="precio-anterior"
                >${{ varianteSeleccionada()!.precio_anterior | number : '1.2-2' }}</span
              >
            }
          </div>
        </div>
        @if (descuento() > 0) {
          <div class="descuento-badge">
            {{ descuento() }}% OFF
          </div>
        }
      </div>

      <!-- Selectores din√°micos de opciones (Color, Talla, etc.) -->
      @for (opcion of opcionesDisponibles(); track opcion.id_opcion) {
        <div class="opcion-section">
          <h3>{{ opcion.nombre_opcion }}:</h3>

          <!-- Si es Color, mostrar como c√≠rculos de color (si aplica) o botones -->
          @if (opcion.nombre_opcion === 'Color') {
            <div class="color-section">
              <div class="colores-grid">
                @for (valor of opcion.valores; track valor.id_valor) {
                  <button
                    [class.selected]="isOpcionSeleccionada(opcion.id_opcion, valor.id_valor)"
                    [class.sin-stock]="!tieneStockDisponible()(opcion.id_opcion, valor.id_valor)"
                    [disabled]="!tieneStockDisponible()(opcion.id_opcion, valor.id_valor)"
                    class="color-btn"
                    (click)="seleccionarOpcion(opcion.id_opcion, valor.id_valor)"
                    [title]="!tieneStockDisponible()(opcion.id_opcion, valor.id_valor) ? 'Sin stock' : valor.valor"
                  >
                    <span
                      class="color-indicator"
                      [style.background-color]="getColorCss(valor.valor)"
                    ></span>
                    <span class="color-nombre">{{ valor.valor }}</span>
                    @if (!tieneStockDisponible()(opcion.id_opcion, valor.id_valor)) {
                      <span class="badge-sin-stock">‚úó</span>
                    }
                  </button>
                }
              </div>
            </div>
          }

          <!-- Si es Talla u otra opci√≥n, mostrar como botones -->
          @if (opcion.nombre_opcion !== 'Color') {
            <div class="talla-section">
              <div class="tallas-grid">
                @for (valor of opcion.valores; track valor.id_valor) {
                  <button
                    [class.selected]="isOpcionSeleccionada(opcion.id_opcion, valor.id_valor)"
                    [class.sin-stock]="!tieneStockDisponible()(opcion.id_opcion, valor.id_valor)"
                    [disabled]="!tieneStockDisponible()(opcion.id_opcion, valor.id_valor)"
                    class="talla-btn"
                    (click)="seleccionarOpcion(opcion.id_opcion, valor.id_valor)"
                    [title]="!tieneStockDisponible()(opcion.id_opcion, valor.id_valor) ? 'Sin stock' : valor.valor"
                  >
                    {{ valor.valor }}
                    @if (!tieneStockDisponible()(opcion.id_opcion, valor.id_valor)) {
                      <span class="icon-sin-stock">‚úó</span>
                    }
                  </button>
                }
              </div>
            </div>
          }
        </div>
      }

      <!-- Stock -->
      <div class="disponibilidad-section">
        <div class="disponibilidad" [ngClass]="stockClass()">
          <div class="stock-indicator">
            <div class="stock-dot"></div>
            <span class="stock-text">{{ stockMessage() }}</span>
          </div>
          <div class="stock-bar">
            <div class="stock-fill" [style.width.%]="stockPercentage()"></div>
          </div>
        </div>
      </div>

      <!-- Cantidad y Bot√≥n de agregar -->
      <div class="compra-section">
        <div class="cantidad-controls">
          <label>Cantidad:</label>
          <div class="cantidad-selector">
            <button (click)="cambiarCantidad(-1)" [disabled]="cantidad() <= 1" class="cantidad-btn">
              <i class="fas fa-minus"></i>
            </button>
            <span class="cantidad-display">{{ cantidad() }}</span>
            <button
              (click)="cambiarCantidad(1)"
              [disabled]="cantidad() >= varianteSeleccionada()!.stock"
              class="cantidad-btn"
            >
              <i class="fas fa-plus"></i>
            </button>
          </div>
        </div>

        <!-- üÜï Mensaje de validaci√≥n -->
        @if (!puedeAgregar() && mensajeValidacion()) {
          <div class="mensaje-validacion">
            <i class="fas fa-exclamation-circle"></i>
            {{ mensajeValidacion() }}
          </div>
        }

        <button
          (click)="agregarAlCarrito()"
          [disabled]="!puedeAgregar()"
          class="btn-agregar-carrito"
        >
          <i class="fas fa-shopping-cart"></i>
          Agregar al carrito
        </button>
      </div>

      <!-- SKU de la variante -->
      <div
        class="sku-section"
        style="margin-top: 1rem; padding: 0.5rem; background: #f8f9fa; border-radius: 6px"
      >
        <small style="color: #6c757d"
          >SKU: <strong>{{ varianteSeleccionada()!.sku }}</strong></small
        >
      </div>

      <!-- M√©todos de pago -->
      <div class="metodos-pago-section">
        <h3>M√©todos de pago aceptados:</h3>
        <div class="metodos-pago">
          <div class="metodo-pago">
            <i class="fab fa-cc-visa"></i>
            <span>Visa</span>
          </div>
          <div class="metodo-pago">
            <i class="fab fa-cc-mastercard"></i>
            <span>Mastercard</span>
          </div>
        </div>
        <p class="pago-info">Pago 100% seguro con encriptaci√≥n SSL</p>
      </div>
    </div>
  </div>

  <!-- Secciones expandibles -->
  <div class="secciones-expandibles">
    <!-- Descripci√≥n -->
    <div class="seccion-expandible">
      <button class="seccion-header" (click)="toggleSeccion('descripcion')">
        <h3>Descripci√≥n del producto</h3>
        <i
          class="fas"
          [class.fa-plus]="!seccionesAbiertas().descripcion"
          [class.fa-minus]="seccionesAbiertas().descripcion"
        ></i>
      </button>
      <div class="seccion-contenido" [class.abierta]="seccionesAbiertas().descripcion">
        <p>{{ producto()!.descripcion }}</p>
      </div>
    </div>

    <!-- Caracter√≠sticas -->
    <div class="seccion-expandible">
      <button class="seccion-header" (click)="toggleSeccion('caracteristicas')">
        <h3>Caracter√≠sticas</h3>
        <i
          class="fas"
          [class.fa-plus]="!seccionesAbiertas().caracteristicas"
          [class.fa-minus]="seccionesAbiertas().caracteristicas"
        ></i>
      </button>
      <div class="seccion-contenido" [class.abierta]="seccionesAbiertas().caracteristicas">
        <ul class="caracteristicas-lista">
          <li><strong>Marca:</strong> {{ producto()!.nombre_marca }}</li>
          <li><strong>Categor√≠a:</strong> {{ producto()!.nombre_categoria }}</li>
          <li><strong>Deporte:</strong> {{ producto()!.nombre_deporte }}</li>
          @if (producto()!.es_nuevo) {
            <li><strong>Estado:</strong> Producto Nuevo</li>
          }
        </ul>
      </div>
    </div>
  </div>

  <!-- Productos relacionados -->
  <app-productos-relacionados
    [categoria]="producto()!.id_categoria"
    [excludeId]="producto()!.id_producto"
  ></app-productos-relacionados>
</div>
}

<!-- Loading state -->
@if (isLoading()) {
<div class="loading-container">
  <div class="loading-spinner">
    <i class="fas fa-spinner fa-spin"></i>
    <p>Cargando producto...</p>
  </div>
</div>
}

<!-- Error state (producto no existe) -->
@if (!isLoading() && !producto()) {
<div class="loading-container">
  <div class="loading-spinner">
    <i class="fas fa-exclamation-triangle" style="color: #e74c3c"></i>
    <p>Producto no encontrado</p>
    <button
      class="btn-volver"
      routerLink="/tienda"
      style="
        margin-top: 1rem;
        padding: 0.75rem 1.5rem;
        background: #3498db;
        color: white;
        border: none;
        border-radius: 6px;
        cursor: pointer;
      "
    >
      Volver a la tienda
    </button>
  </div>
</div>
}
