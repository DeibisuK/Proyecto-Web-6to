<div class="historial-container">

  <!-- Filtros -->
  <div class="filtros-section">
    <div class="search-box">
      <span class="material-icons">search</span>
      <input
        type="text"
        placeholder="Buscar por equipo, torneo, cancha..."
        [(ngModel)]="busqueda"
        (ngModelChange)="aplicarFiltros()"
      />
    </div>

    <div class="filtro-estado" [class.activo]="dropdownEstadoAbierto()">
      <button
        type="button"
        class="btn-dropdown-filtro"
        (click)="toggleDropdownEstado()"
        [class.activo]="dropdownEstadoAbierto()">
        <span class="dropdown-current">
          <i class="fas fa-flag"></i>
          {{ estadoSeleccionado() }}
        </span>
        <i class="fas fa-chevron-down"></i>
      </button>

      @if (dropdownEstadoAbierto()) {
        <div class="dropdown-menu-filtro">
          <button
            type="button"
            class="dropdown-item-filtro"
            [class.seleccionado]="filtroEstado() === 'todos'"
            (click)="seleccionarEstado('todos')">
            <i class="fas fa-th"></i>
            <span class="opcion-label">Todos los estados</span>
            @if (filtroEstado() === 'todos') {
              <i class="fas fa-check check-icon"></i>
            }
          </button>
          <button
            type="button"
            class="dropdown-item-filtro"
            [class.seleccionado]="filtroEstado() === 'finalizado'"
            (click)="seleccionarEstado('finalizado')">
            <i class="fas fa-check-circle"></i>
            <span class="opcion-label">Finalizados</span>
            @if (filtroEstado() === 'finalizado') {
              <i class="fas fa-check check-icon"></i>
            }
          </button>
          <button
            type="button"
            class="dropdown-item-filtro"
            [class.seleccionado]="filtroEstado() === 'en_curso'"
            (click)="seleccionarEstado('en_curso')">
            <i class="fas fa-play-circle"></i>
            <span class="opcion-label">En Curso</span>
            @if (filtroEstado() === 'en_curso') {
              <i class="fas fa-check check-icon"></i>
            }
          </button>
          <button
            type="button"
            class="dropdown-item-filtro"
            [class.seleccionado]="filtroEstado() === 'pausado'"
            (click)="seleccionarEstado('pausado')">
            <i class="fas fa-pause-circle"></i>
            <span class="opcion-label">Pausados</span>
            @if (filtroEstado() === 'pausado') {
              <i class="fas fa-check check-icon"></i>
            }
          </button>
          <button
            type="button"
            class="dropdown-item-filtro"
            [class.seleccionado]="filtroEstado() === 'programado'"
            (click)="seleccionarEstado('programado')">
            <i class="fas fa-clock"></i>
            <span class="opcion-label">Programados</span>
            @if (filtroEstado() === 'programado') {
              <i class="fas fa-check check-icon"></i>
            }
          </button>
          <button
            type="button"
            class="dropdown-item-filtro"
            [class.seleccionado]="filtroEstado() === 'cancelado'"
            (click)="seleccionarEstado('cancelado')">
            <i class="fas fa-times-circle"></i>
            <span class="opcion-label">Cancelados</span>
            @if (filtroEstado() === 'cancelado') {
              <i class="fas fa-check check-icon"></i>
            }
          </button>
        </div>
      }
    </div>

    <div class="stat-badge">
      <span class="material-icons">list</span>
      <span>{{ partidosFiltrados().length }} partidos</span>
    </div>

    <button class="btn-limpiar" (click)="limpiarFiltros()">
      <i class="fas fa-eraser"></i>
      Limpiar Filtros
    </button>
  </div>

  <!-- Contador de resultados -->
  <div class="resultados-info">
    <span class="contador">
      <i class="fas fa-list"></i>
      Mostrando {{ partidosPaginados.length }} de {{ partidosFiltrados().length }} partidos
    </span>
  </div>

  <!-- Loading -->
  @if (cargando()) {
    <div class="loading">
      <div class="spinner"></div>
      <p>Cargando historial...</p>
    </div>
  }

  <!-- Tabla de partidos -->
  @if (!cargando() && partidosFiltrados().length > 0) {
    <div class="tabla-container">
      <table class="tabla-historial">
        <thead>
          <tr>
            <th>Fecha</th>
            <th>Torneo</th>
            <th>Partido</th>
            <th>Resultado</th>
            <th>Cancha</th>
            <th>Sede</th>
            <th>Árbitro</th>
            <th>Estado</th>
          </tr>
        </thead>
        <tbody>
          @for (partido of partidosPaginados; track partido.id_partido) {
            <tr>
              <!-- Fecha y hora -->
              <td class="fecha-cell">
                <div class="fecha-info">
                  <span class="fecha">{{ partido.fecha_partido | date:'dd/MM/yyyy' }}</span>
                  <span class="hora">{{ partido.hora_inicio }}</span>
                </div>
              </td>

              <!-- Torneo -->
              <td class="torneo-cell">
                <div class="torneo-info">
                  <i class="fas fa-trophy"></i>
                  <div>
                    <span class="torneo-nombre">{{ partido.torneo_nombre }}</span>
                    <span class="deporte">{{ partido.nombre_deporte }}</span>
                  </div>
                </div>
              </td>

              <!-- Equipos -->
              <td class="equipos-cell">
                <div class="partido-info">
                  <div class="equipo">
                    <img [src]="partido.logo_equipo_local" [alt]="partido.nombre_equipo_local" class="logo-mini">
                    <span>{{ partido.nombre_equipo_local }}</span>
                  </div>
                  <span class="vs">vs</span>
                  <div class="equipo">
                    <img [src]="partido.logo_equipo_visitante" [alt]="partido.nombre_equipo_visitante" class="logo-mini">
                    <span>{{ partido.nombre_equipo_visitante }}</span>
                  </div>
                </div>
              </td>

              <!-- Resultado -->
              <td class="resultado-cell">
                @if (partido.estado_partido === 'finalizado') {
                  <div class="resultado-final">
                    <span class="marcador">{{ partido.resultado_local }}</span>
                    <span class="separador">-</span>
                    <span class="marcador">{{ partido.resultado_visitante }}</span>
                  </div>
                } @else {
                  <span class="sin-resultado">-</span>
                }
              </td>

              <!-- Cancha -->
              <td class="cancha-cell">
                <i class="fas fa-map-marker-alt"></i>
                {{ partido.nombre_cancha || 'Sin asignar' }}
              </td>

              <!-- Sede -->
              <td class="sede-cell">
                {{ partido.sede_nombre }}
              </td>

              <!-- Árbitro -->
              <td class="arbitro-cell">
                <i class="fas fa-user-tie"></i>
                {{ partido.nombre_arbitro || 'Sin asignar' }}
              </td>

              <!-- Estado -->
              <td class="estado-cell">
                <span class="badge-estado" [ngClass]="getEstadoClase(partido.estado_partido)">
                  {{ getEstadoTexto(partido.estado_partido) }}
                </span>
              </td>
            </tr>
          }
        </tbody>
      </table>
    </div>

    <!-- Paginación -->
    @if (totalPaginas > 1) {
      <div class="paginacion">
        <button
          class="btn-pagina"
          [disabled]="paginaActual() === 1"
          (click)="cambiarPagina(paginaActual() - 1)">
          <i class="fas fa-chevron-left"></i>
        </button>

        @for (pagina of [].constructor(totalPaginas); track $index; let i = $index) {
          <button
            class="btn-pagina"
            [class.active]="paginaActual() === i + 1"
            (click)="cambiarPagina(i + 1)">
            {{ i + 1 }}
          </button>
        }

        <button
          class="btn-pagina"
          [disabled]="paginaActual() === totalPaginas"
          (click)="cambiarPagina(paginaActual() + 1)">
          <i class="fas fa-chevron-right"></i>
        </button>
      </div>
    }
  }

  <!-- Sin resultados -->
  @if (!cargando() && partidosFiltrados().length === 0) {
    <div class="sin-resultados">
      <i class="fas fa-inbox"></i>
      <h3>No se encontraron partidos</h3>
      <p>Intenta ajustar los filtros de búsqueda</p>
      <button class="btn-limpiar-inline" (click)="limpiarFiltros()">
        <i class="fas fa-eraser"></i> Limpiar Filtros
      </button>
    </div>
  }
</div>
