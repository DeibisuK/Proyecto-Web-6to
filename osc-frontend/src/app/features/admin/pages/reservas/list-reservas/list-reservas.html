<div class="list-reservas-container">
  <!-- Filtros y Búsqueda -->
  <div class="filtros-section">
    <div class="search-box">
      <span class="material-icons">search</span>
      <input
        type="text"
        placeholder="Buscar por cancha, usuario o email..."
        [(ngModel)]="filtroBusqueda"
        (ngModelChange)="aplicarFiltros()"
      />
    </div>

    <div class="filtro-estado" [class.activo]="dropdownEstadoAbierto()">
      <button
        type="button"
        class="btn-dropdown-filtro"
        (click)="toggleDropdownEstado()"
        [class.activo]="dropdownEstadoAbierto()">
        <span class="dropdown-current">
          <i class="fas fa-filter"></i>
          {{ estadoSeleccionado() }}
        </span>
        <i class="fas fa-chevron-down"></i>
      </button>

      @if (dropdownEstadoAbierto()) {
        <div class="dropdown-menu-filtro">
          <button
            type="button"
            class="dropdown-item-filtro"
            [class.seleccionado]="filtroEstado === 'todos'"
            (click)="seleccionarEstado('todos')">
            <i class="fas fa-th"></i>
            <span class="opcion-label">Todos los estados</span>
            @if (filtroEstado === 'todos') {
              <i class="fas fa-check check-icon"></i>
            }
          </button>
          <button
            type="button"
            class="dropdown-item-filtro"
            [class.seleccionado]="filtroEstado === 'pendiente'"
            (click)="seleccionarEstado('pendiente')">
            <i class="fas fa-clock"></i>
            <span class="opcion-label">Pendiente</span>
            @if (filtroEstado === 'pendiente') {
              <i class="fas fa-check check-icon"></i>
            }
          </button>
          <button
            type="button"
            class="dropdown-item-filtro"
            [class.seleccionado]="filtroEstado === 'pagado'"
            (click)="seleccionarEstado('pagado')">
            <i class="fas fa-check-circle"></i>
            <span class="opcion-label">Pagado</span>
            @if (filtroEstado === 'pagado') {
              <i class="fas fa-check check-icon"></i>
            }
          </button>
          <button
            type="button"
            class="dropdown-item-filtro"
            [class.seleccionado]="filtroEstado === 'cancelado'"
            (click)="seleccionarEstado('cancelado')">
            <i class="fas fa-times-circle"></i>
            <span class="opcion-label">Cancelado</span>
            @if (filtroEstado === 'cancelado') {
              <i class="fas fa-check check-icon"></i>
            }
          </button>
          <button
            type="button"
            class="dropdown-item-filtro"
            [class.seleccionado]="filtroEstado === 'reembolsado'"
            (click)="seleccionarEstado('reembolsado')">
            <i class="fas fa-undo"></i>
            <span class="opcion-label">Reembolsado</span>
            @if (filtroEstado === 'reembolsado') {
              <i class="fas fa-check check-icon"></i>
            }
          </button>
        </div>
      }
    </div>

    <div class="stat-badge">
      <span class="material-icons">event</span>
      {{ reservasFiltradas().length }} Reserva{{ reservasFiltradas().length !== 1 ? 's' : '' }}
    </div>

    <button class="btn-crear" routerLink="/admin/configurar-horarios">
      <span class="material-icons">add</span>
      Configurar Horarios
    </button>
  </div>

  <!-- Tabla de reservas -->
  <div class="table-section">
    @if (cargando()) {
      <div class="loading-spinner">
        <i class="fas fa-spinner fa-spin"></i>
        <p>Cargando reservas...</p>
      </div>
    } @else if (getReservasPaginadas().length === 0) {
      <div class="empty-state">
        <i class="fas fa-calendar-times"></i>
        <h3>No hay reservas</h3>
        <p>No se encontraron reservas con los filtros aplicados</p>
        <button class="btn btn-primary" routerLink="/admin/configurar-horarios">
          Configurar Horarios
        </button>
      </div>
    } @else {
      <div class="table-responsive">
        <table class="table">
          <thead>
            <tr>
              <th>ID</th>
              <th>Fecha</th>
              <th>Horario</th>
              <th>Cancha</th>
              <th>Usuario</th>
              <th>Monto</th>
              <th>Estado</th>
              <th>Tipo Pago</th>
              <th>Acciones</th>
            </tr>
          </thead>
          <tbody>
            @for (reserva of getReservasPaginadas(); track reserva.id_reserva) {
              <tr>
                <td>#{{ reserva.id_reserva }}</td>
                <td>{{ reserva.fecha_reserva }}</td>
                <td>
                  {{ reserva.hora_inicio }} - {{ reserva.hora_fin }}
                  <small>({{ reserva.duracion_minutos }} min)</small>
                </td>
                <td>
                  <strong>{{ reserva.nombre_cancha }}</strong><br>
                  <small>{{ reserva.nombre_sede }}</small>
                </td>
                <td>
                  {{ reserva.nombre_usuario || 'Sin nombre' }}<br>
                  <small>{{ reserva.email_usuario }}</small>
                </td>
                <td>{{ formatearMoneda(reserva.monto_total) }}</td>
                <td>
                  <span [class]="'badge ' + getEstadoPagoClass(reserva.estado_pago)">
                    {{ getEstadoPagoTexto(reserva.estado_pago) }}
                  </span>
                </td>
                <td>
                  {{ getTipoPagoTexto(reserva.tipo_pago) }}
                </td>
                <td>
                  @if (reserva.estado_pago === 'pendiente') {
                    <button
                      class="btn-sm btn-outline-success"
                      title="Marcar como pagado"
                      (click)="actualizarEstado(reserva, 'pagado')"
                    >
                      <i class="fas fa-check"></i>
                    </button>
                    <button
                      class="btn-sm btn-outline-danger"
                      title="Cancelar"
                      (click)="actualizarEstado(reserva, 'cancelado')"
                    >
                      <i class="fas fa-times"></i>
                    </button>
                  }
                  @if (reserva.estado_pago === 'pagado') {
                    <button
                      class="btn-sm btn-outline-warning"
                      title="Reembolsar"
                      (click)="actualizarEstado(reserva, 'reembolsado')"
                    >
                      <i class="fas fa-undo"></i>
                    </button>
                  }
                  <button
                    class="btn-sm btn-outline-danger"
                    title="Eliminar"
                    (click)="confirmarEliminar(reserva)"
                  >
                    <i class="fas fa-trash"></i>
                  </button>
                </td>
              </tr>
            }
          </tbody>
        </table>

        <!-- Paginación en el footer -->
        <div class="pagination-section">
          <button
            [disabled]="paginaActual === 1"
            (click)="cambiarPagina(paginaActual - 1)"
          >
            Anterior
          </button>
          <span>Página {{ paginaActual }} de {{ totalPaginas }}</span>
          <button
            [disabled]="paginaActual === totalPaginas"
            (click)="cambiarPagina(paginaActual + 1)"
          >
            Siguiente
          </button>
        </div>
      </div>
    }
  </div>
</div>

