<!-- orders-sales.component.html -->
<div class="orders-sales-container">

  <!-- Stats Cards -->
  <div class="stats-grid">
    <div class="stat-card">
      <div class="stat-icon blue">
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
          <path d="M6 2L3 6v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2V6l-3-4zM3 6h18M16 10a4 4 0 0 1-8 0"/>
        </svg>
      </div>
      <div class="stat-content">
        <span class="stat-label">Pedidos Hoy</span>
        <span class="stat-value">{{ todayOrders }}</span>
      </div>
    </div>

    <div class="stat-card">
      <div class="stat-icon green">
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
          <path d="M12 2v20M17 5H9.5a3.5 3.5 0 0 0 0 7h5a3.5 3.5 0 0 1 0 7H6"/>
        </svg>
      </div>
      <div class="stat-content">
        <span class="stat-label">Ventas del Mes</span>
        <span class="stat-value">${{ monthlySales | number }}</span>
      </div>
    </div>

    <div class="stat-card">
      <div class="stat-icon amber">
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
          <circle cx="12" cy="12" r="10"/><path d="M12 6v6l4 2"/>
        </svg>
      </div>
      <div class="stat-content">
        <span class="stat-label">Pendientes</span>
        <span class="stat-value">{{ pendingOrders }}</span>
      </div>
    </div>

    <div class="stat-card">
      <div class="stat-icon purple">
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
          <path d="M22 11.08V12a10 10 0 1 1-5.93-9.14"/><path d="M22 4L12 14.01l-3-3"/>
        </svg>
      </div>
      <div class="stat-content">
        <span class="stat-label">Completados</span>
        <span class="stat-value">{{ completedOrders }}</span>
      </div>
    </div>
  </div>

  <!-- Tabs Navigation -->
  <div class="tabs-container">
    <div class="tabs-nav">
      <button
        class="tab-btn"
        [class.active]="activeTab === 'orders'"
        (click)="setActiveTab('orders')">
        <svg class="tab-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
          <path d="M6 2L3 6v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2V6l-3-4zM3 6h18"/>
        </svg>
        Pedidos
        <span class="tab-badge">{{ orders.length }}</span>
      </button>
      <button
        class="tab-btn"
        [class.active]="activeTab === 'sales'"
        (click)="setActiveTab('sales')">
        <svg class="tab-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
          <path d="M12 2v20M17 5H9.5a3.5 3.5 0 0 0 0 7h5a3.5 3.5 0 0 1 0 7H6"/>
        </svg>
        Ventas
        <span class="tab-badge green">{{ completedOrders }}</span>
      </button>
    </div>

    <!-- Filters Bar -->
    <div class="filters-bar">
      <div class="search-box">
        <svg class="search-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
          <circle cx="11" cy="11" r="8"/><path d="M21 21l-4.35-4.35"/>
        </svg>
        <input
          type="text"
          placeholder="Buscar por ID, cliente, producto..."
          [(ngModel)]="searchQuery"
          (input)="onSearch()">
      </div>

      <div class="filter-group">
        <select class="filter-select" [(ngModel)]="statusFilter" (change)="applyFilters()">
          <option value="">Todos los estados</option>
          <option value="Pendiente">Pendientes</option>
          <option value="Procesando">En proceso</option>
          <option value="Enviado">Enviado</option>
          <option value="Entregado">Entregado</option>
          <option value="Cancelado">Cancelado</option>
        </select>

        <select class="filter-select" [(ngModel)]="dateFilter" (change)="applyFilters()">
          <option value="today">Hoy</option>
          <option value="week">Esta semana</option>
          <option value="month">Este mes</option>
          <option value="custom">Personalizado</option>
        </select>
      </div>
    </div>

    <!-- Tab Content: Orders -->
    <div class="tab-content" *ngIf="activeTab === 'orders'">
      <div class="table-container">
        <table class="data-table">
          <thead>
            <tr>
              <th class="checkbox-col">
                <input type="checkbox" (change)="toggleSelectAll($event)">
              </th>
              <th>ID Pedido</th>
              <th>Cliente</th>
              <th>Items</th>
              <th>Fecha</th>
              <th>Total</th>
              <th>Estado</th>
              <th>Acciones</th>
            </tr>
          </thead>
          <tbody>
            <tr *ngFor="let order of paginatedOrders" class="table-row">
              <td class="checkbox-col">
                <input type="checkbox" [(ngModel)]="order.selected">
              </td>
              <td>
                <span class="order-id">#{{ order.id_pedido }}</span>
              </td>
              <td>
                <div class="customer-cell">
                  <div class="customer-avatar">{{ getCustomerInitials(order.nombre_usuario) }}</div>
                  <div class="customer-info">
                    <span class="customer-name">{{ order.nombre_usuario || 'Usuario' }}</span>
                    <span class="customer-email">{{ order.email_usuario || 'N/A' }}</span>
                  </div>
                </div>
              </td>
              <td>
                <span class="type-badge product">
                  {{ order.total_items }} producto(s)
                </span>
              </td>
              <td>
                <div class="date-cell">
                  <span class="date">{{ order.fecha_pedido | date:'dd MMM yyyy' }}</span>
                  <span class="time">{{ order.fecha_pedido | date:'HH:mm' }}</span>
                </div>
              </td>
              <td>
                <span class="amount">${{ order.total | number:'1.2-2' }}</span>
              </td>
              <td>
                <span class="status-badge" [ngClass]="getStatusClass(order.estado_pedido)">
                  {{ getStatusLabel(order.estado_pedido) }}
                </span>
              </td>
              <td>
                <div class="actions-cell">
                  <button class="action-btn view" title="Ver detalle" (click)="viewOrder(order)">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                      <path d="M1 12s4-8 11-8 11 8 11 8-4 8-11 8-11-8-11-8z"/>
                      <circle cx="12" cy="12" r="3"/>
                    </svg>
                  </button>
                  <button class="action-btn delete" title="Cancelar" (click)="cancelOrder(order)"
                          [disabled]="order.estado_pedido === 'Cancelado'">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                      <path d="M3 6h18M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"/>
                    </svg>
                  </button>
                </div>
              </td>
            </tr>
          </tbody>
        </table>
      </div>

      <!-- Pagination -->
      <div class="pagination">
        <div class="pagination-info">
          Mostrando {{ startIndex }} - {{ endIndex }} de {{ filteredOrders.length }} pedidos
        </div>
        <div class="pagination-controls">
          <button class="page-btn" [disabled]="currentPage === 1" (click)="prevPage()">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <path d="M15 18l-6-6 6-6"/>
            </svg>
          </button>
          <button
            *ngFor="let page of pages"
            class="page-btn"
            [class.active]="page === currentPage"
            (click)="goToPage(page)">
            {{ page }}
          </button>
          <button class="page-btn" [disabled]="currentPage === totalPages" (click)="nextPage()">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <path d="M9 18l6-6-6-6"/>
            </svg>
          </button>
        </div>
      </div>
    </div>

    <!-- Tab Content: Sales -->
    <div class="tab-content" *ngIf="activeTab === 'sales'">
      <div class="sales-summary">
        <div class="summary-card">
          <h4>Resumen de Ventas</h4>
          <div class="summary-grid">
            <div class="summary-item">
              <span class="summary-label">Total Pedidos</span>
              <span class="summary-value">{{ totalOrders }}</span>
            </div>
            <div class="summary-item">
              <span class="summary-label">Pedidos Hoy</span>
              <span class="summary-value">{{ todayOrders }}</span>
            </div>
            <div class="summary-item">
              <span class="summary-label">Ventas Hoy</span>
              <span class="summary-value">${{ todaySales | number:'1.2-2' }}</span>
            </div>
            <div class="summary-item highlight">
              <span class="summary-label">Ventas del Mes</span>
              <span class="summary-value">${{ monthlySales | number:'1.2-2' }}</span>
            </div>
          </div>
        </div>
      </div>

      <div class="table-container">
        <table class="data-table">
          <thead>
            <tr>
              <th>ID Pedido</th>
              <th>UUID Factura</th>
              <th>Cliente</th>
              <th>Items</th>
              <th>Fecha</th>
              <th>Total</th>
              <th>Estado</th>
              <th>Acciones</th>
            </tr>
          </thead>
          <tbody>
            <tr *ngFor="let order of paginatedOrders" class="table-row">
              <td><span class="order-id">#{{ order.id_pedido }}</span></td>
              <td><span class="order-id">{{ order.uuid_factura }}</span></td>
              <td>
                <div class="customer-cell">
                  <div class="customer-avatar">{{ getCustomerInitials(order.nombre_usuario) }}</div>
                  <div class="customer-info">
                    <span class="customer-name">{{ order.nombre_usuario || 'Usuario' }}</span>
                    <span class="customer-email">{{ order.email_usuario || 'N/A' }}</span>
                  </div>
                </div>
              </td>
              <td>
                <span class="type-badge product">
                  {{ order.total_items }} producto(s)
                </span>
              </td>
              <td>
                <div class="date-cell">
                  <span class="date">{{ order.fecha_pedido | date:'dd MMM yyyy' }}</span>
                  <span class="time">{{ order.fecha_pedido | date:'HH:mm' }}</span>
                </div>
              </td>
              <td><span class="amount">${{ order.total | number:'1.2-2' }}</span></td>
              <td>
                <span class="status-badge" [ngClass]="getStatusClass(order.estado_pedido)">
                  {{ getStatusLabel(order.estado_pedido) }}
                </span>
              </td>
              <td>
                <div class="actions-cell">
                  <button class="action-btn view" title="Ver detalle" (click)="viewOrder(order)">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                      <path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"/>
                      <path d="M14 2v6h6M16 13H8M16 17H8M10 9H8"/>
                    </svg>
                  </button>
                </div>
              </td>
            </tr>
          </tbody>
        </table>
      </div>
    </div>

  </div>
</div>

<!-- Order Detail Modal -->
<div class="modal-overlay" *ngIf="showOrderModal" (click)="closeModal()">
  <div class="modal-content" (click)="$event.stopPropagation()">
    <div class="modal-header">
      <h2>Detalle del Pedido #{{ selectedOrder?.id_pedido }}</h2>
      <button class="close-btn" (click)="closeModal()">
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
          <path d="M18 6L6 18M6 6l12 12"/>
        </svg>
      </button>
    </div>
    <div class="modal-body" *ngIf="selectedOrder">
      <div class="order-info-grid">
        <div class="info-section">
          <h3>Información del Cliente</h3>
          <p><strong>Nombre:</strong> {{ selectedOrder.nombre_usuario }}</p>
          <p><strong>Email:</strong> {{ selectedOrder.email_usuario }}</p>
          <p><strong>UUID Factura:</strong> {{ selectedOrder.uuid_factura }}</p>
        </div>

        <div class="info-section">
          <h3>Información del Pedido</h3>
          <p><strong>Fecha:</strong> {{ selectedOrder.fecha_pedido | date:'dd MMM yyyy, HH:mm' }}</p>
          <p><strong>Estado:</strong>
            <span class="status-badge" [ngClass]="getStatusClass(selectedOrder.estado_pedido)">
              {{ getStatusLabel(selectedOrder.estado_pedido) }}
            </span>
          </p>
          <p><strong>Total:</strong> ${{ selectedOrder.total | number:'1.2-2' }}</p>
        </div>
      </div>

      <div class="items-section">
        <h3>Productos</h3>
        <table class="items-table">
          <thead>
            <tr>
              <th>Producto</th>
              <th>SKU</th>
              <th>Cantidad</th>
              <th>Precio Unit.</th>
              <th>Subtotal</th>
            </tr>
          </thead>
          <tbody>
            <tr *ngFor="let item of selectedOrder.items">
              <td>
                <div class="item-cell">
                  <img *ngIf="item.imagen_producto" [src]="item.imagen_producto" alt="{{ item.nombre_producto }}" class="item-image">
                  <span>{{ item.nombre_producto }}</span>
                </div>
              </td>
              <td>{{ item.sku }}</td>
              <td>{{ item.cantidad }}</td>
              <td>${{ item.precio_unitario | number:'1.2-2' }}</td>
              <td>${{ item.subtotal | number:'1.2-2' }}</td>
            </tr>
          </tbody>
          <tfoot>
            <tr>
              <td colspan="4" class="text-right"><strong>Total:</strong></td>
              <td><strong>${{ selectedOrder.total | number:'1.2-2' }}</strong></td>
            </tr>
          </tfoot>
        </table>
      </div>
    </div>
  </div>
</div>
