<div class="torneos-container">
  <!-- Filtros -->
  <div class="filtros-section">
    <div class="search-box">
      <span class="material-icons">search</span>
      <input
        type="text"
        placeholder="Buscar torneos..."
        [(ngModel)]="filtros.busqueda"
        (ngModelChange)="aplicarFiltros()"
      />
    </div>

    <div class="filtro-deporte" [class.activo]="dropdownDeporteAbierto()">
      <button type="button" class="btn-dropdown-filtro" [class.activo]="dropdownDeporteAbierto()" (click)="toggleDropdownDeporte()">
        <span class="dropdown-current">
          <i class="fas fa-futbol"></i>
          <span>{{ deporteSeleccionado() }}</span>
        </span>
        <i class="fas fa-chevron-down"></i>
      </button>
      @if (dropdownDeporteAbierto()) {
        <div class="dropdown-menu-filtro">
          <button type="button" class="dropdown-item-filtro" [class.seleccionado]="filtros.deporte === undefined" (click)="seleccionarDeporte(undefined)">
            <i class="fas fa-th"></i>
            <span class="opcion-label">Todos los deportes</span>
            @if (filtros.deporte === undefined) {
              <i class="fas fa-check check-icon"></i>
            }
          </button>
          @for (deporte of deportes; track deporte.id_deporte) {
            <button type="button" class="dropdown-item-filtro" [class.seleccionado]="filtros.deporte === deporte.id_deporte" (click)="seleccionarDeporte(deporte.id_deporte)">
              <i class="fas fa-futbol"></i>
              <span class="opcion-label">{{ deporte.nombre_deporte }}</span>
              @if (filtros.deporte === deporte.id_deporte) {
                <i class="fas fa-check check-icon"></i>
              }
            </button>
          }
        </div>
      }
    </div>

    <div class="filtro-estado" [class.activo]="dropdownEstadoAbierto()">
      <button type="button" class="btn-dropdown-filtro" [class.activo]="dropdownEstadoAbierto()" (click)="toggleDropdownEstado()">
        <span class="dropdown-current">
          <i class="fas fa-flag"></i>
          <span>{{ estadoSeleccionado() }}</span>
        </span>
        <i class="fas fa-chevron-down"></i>
      </button>
      @if (dropdownEstadoAbierto()) {
        <div class="dropdown-menu-filtro">
          @for (estado of estadosPosibles; track estado.value) {
            <button type="button" class="dropdown-item-filtro" [class.seleccionado]="filtros.estado === (estado.value || undefined)" (click)="seleccionarEstado(estado.value || undefined)">
              <i class="fas fa-flag"></i>
              <span class="opcion-label">{{ estado.label }}</span>
              @if (filtros.estado === (estado.value || undefined)) {
                <i class="fas fa-check check-icon"></i>
              }
            </button>
          }
        </div>
      }
    </div>

    <div class="stat-badge">
      <span class="material-icons">emoji_events</span>
      {{ totalTorneos }} Torneo{{ totalTorneos !== 1 ? 's' : '' }}
    </div>

    <button type="button" class="btn-limpiar" (click)="limpiarFiltros()">
      <i class="fas fa-eraser"></i>
      Limpiar filtros
    </button>
  </div>

  <!-- Estadísticas rápidas -->
  <div class="stats-bar">
    <div class="stat-item">
      <i class="fas fa-trophy"></i>
      <span class="stat-value">{{ totalTorneos }}</span>
      <span class="stat-label">Total Torneos</span>
    </div>
    <button class="btn-crear" (click)="crearTorneo()">
      <i class="fas fa-plus"></i>
      Crear Torneo
    </button>
  </div>

  <!-- Lista de torneos -->
  <div class="torneos-list">

    <!-- Skeleton Loading -->
    @if (cargando) {
      @for (i of [1,2,3,4,5,6]; track i) {
        <div class="torneo-card skeleton-card">
          <div class="card-header">
            <div class="torneo-info">
              <div class="skeleton skeleton-title"></div>
              <div class="skeleton skeleton-text"></div>
            </div>
            <div class="skeleton skeleton-badge"></div>
          </div>

          <div class="card-body">
            <div class="torneo-detalles">
              <div class="detalle-item">
                <div class="skeleton skeleton-icon"></div>
                <div class="skeleton skeleton-text-small"></div>
              </div>
              <div class="detalle-item">
                <div class="skeleton skeleton-icon"></div>
                <div class="skeleton skeleton-text-small"></div>
              </div>
              <div class="detalle-item">
                <div class="skeleton skeleton-icon"></div>
                <div class="skeleton skeleton-text-small"></div>
              </div>
              <div class="detalle-item">
                <div class="skeleton skeleton-icon"></div>
                <div class="skeleton skeleton-text-small"></div>
              </div>
            </div>
          </div>

          <div class="card-footer">
            <div class="acciones-grupo">
              <div class="skeleton skeleton-button"></div>
              <div class="skeleton skeleton-button"></div>
              <div class="skeleton skeleton-button"></div>
            </div>
          </div>
        </div>
      }
    }

    <!-- Empty State -->
    @if (!cargando && torneos.length === 0) {
    <div class="empty-state">
      <i class="fas fa-trophy"></i>
      <p>No se encontraron torneos</p>
      <button class="btn-crear-empty" (click)="crearTorneo()">
        <i class="fas fa-plus"></i>
        Crear primer torneo
      </button>
    </div>
    }

    <!-- Torneos -->
    @if (!cargando && torneos.length > 0) {
      @for (torneo of torneos; track $index) {
    <div class="torneo-card">
      <div class="card-header">
        <div class="torneo-info">
          <h3 class="torneo-nombre">{{ torneo.nombre }}</h3>
          @if (torneo.descripcion) {
          <p class="torneo-descripcion">
            {{ torneo.descripcion }}
          </p>
          }
        </div>
        <span class="estado-badge" [ngClass]="getEstadoClass(torneo.estado)">
          {{ getEstadoLabel(torneo.estado) }}
        </span>
      </div>

      <div class="card-body">
        <div class="torneo-detalles">
          <!-- Deporte -->
          <div class="detalle-item">
            <i class="fas fa-futbol"></i>
            <span>{{ torneo.nombre_deporte }}</span>
          </div>

          <!-- Fechas -->
          <div class="detalle-item">
            <i class="fas fa-calendar"></i>
            <span>{{ formatearFecha(torneo.fecha_inicio) }} - {{ formatearFecha(torneo.fecha_fin) }}</span>
          </div>

          <!-- Equipos -->
          <div class="detalle-item">
            <i class="fas fa-users"></i>
            <span>{{ torneo.equipos_inscritos || 0 }} / {{ torneo.max_equipos || '∞' }} equipos</span>
          </div>

          <!-- Partidos -->
          @if (torneo.total_partidos && torneo.total_partidos > 0) {
          <div class="detalle-item">
            <i class="fas fa-futbol"></i>
            <span>{{ torneo.partidos_finalizados || 0 }} / {{ torneo.total_partidos }} partidos</span>
          </div>
          }

          <!-- Tipo -->
          <div class="detalle-item">
            <i class="fas fa-sitemap"></i>
            <span>{{ torneo.tipo_torneo }}</span>
          </div>

          <!-- Creador -->
          @if (torneo.creador_nombre) {
          <div class="detalle-item">
            <i class="fas fa-user"></i>
            <span>{{ torneo.creador_nombre }}</span>
          </div>
          }
        </div>
      </div>

      <div class="card-footer">
        <div class="acciones-grupo">
          <button class="btn-accion btn-bracket" (click)="abrirModalBracket(torneo)" title="Ver Bracket">
            <i class="fas fa-sitemap"></i>
            Bracket
          </button>

          <!-- Botón Generar Calendario (solo si estado es 'cerrado', no tiene partidos y tiene equipos inscritos) -->
          @if (torneo.estado === 'cerrado' && (!torneo.total_partidos || +torneo.total_partidos === 0) && torneo.equipos_inscritos && +torneo.equipos_inscritos > 0) {
            <button class="btn-accion btn-fixture" (click)="generarFixture(torneo)" title="Generar Calendario de Partidos">
              <i class="fas fa-calendar-plus"></i>
              Generar Calendario
            </button>
          }

          <button class="btn-accion btn-editar" (click)="editarTorneo(torneo)" title="Editar">
            <i class="fas fa-edit"></i>
            Editar
          </button>

          <button class="btn-accion btn-stats" (click)="verEstadisticas(torneo)" title="Estadísticas">
            <i class="fas fa-chart-bar"></i>
            Estadísticas
          </button>

          <!-- Cambiar estado -->
          @if (torneo.id_torneo) {
            <div class="btn-dropdown" [class.activo]="dropdownEstadoTorneoId === torneo.id_torneo">
              <button class="btn-accion btn-estado" (click)="toggleDropdownEstadoTorneo($event, torneo.id_torneo)">
                <i class="fas fa-sync-alt"></i>
                Estado
                <i class="fas fa-chevron-down" [class.rotado]="dropdownEstadoTorneoId === torneo.id_torneo"></i>
              </button>
              @if (dropdownEstadoTorneoId === torneo.id_torneo) {
                <div class="dropdown-content" (click)="$event.stopPropagation()">
                  @for (estado of estadosPosibles; track estado.value) {
                  <button
                    (click)="cambiarEstado(torneo, estado.value)"
                    [disabled]="!estado.value || torneo.estado === estado.value"
                    class="dropdown-item"
                  >
                    {{ estado.label }}
                  </button>
                  }
                </div>
              }
            </div>
          }

          <button class="btn-accion btn-eliminar" (click)="eliminarTorneo(torneo)" title="Eliminar">
            <i class="fas fa-trash"></i>
            Eliminar
          </button>
        </div>
      </div>
    </div>
    }
    }
  </div>

  <!-- Paginación -->
  @if (totalPages > 1) {
  <div class="paginacion">
    <button
      class="btn-paginacion"
      (click)="cambiarPagina((filtros.page || 1) - 1)"
      [disabled]="(filtros.page || 1) === 1"
    >
      <i class="fas fa-chevron-left"></i>
      Anterior
    </button>

    <div class="paginas-numeros">
      @for (pagina of getPaginaNumeros(); track pagina) {
      <button
        class="btn-numero"
        [ngClass]="{ 'activo': pagina === filtros.page }"
        (click)="cambiarPagina(pagina)"
      >
        {{ pagina }}
      </button>
      }
    </div>

    <button
      class="btn-paginacion"
      (click)="cambiarPagina((filtros.page || 1) + 1)"
      [disabled]="(filtros.page || 1) === totalPages"
    >
      Siguiente
      <i class="fas fa-chevron-right"></i>
    </button>
  </div>
  }
</div>

<!-- Modal Bracket -->
@if (mostrarModalBracket()) {
  <div class="modal-overlay" (click)="cerrarModalBracket()">
    <div class="modal-bracket" (click)="$event.stopPropagation()">
      <div class="modal-header">
        <h2>
          <i class="fas fa-sitemap"></i>
          Bracket: {{ torneoSeleccionado?.nombre }}
        </h2>
        <button class="btn-cerrar" (click)="cerrarModalBracket()">
          <i class="fas fa-times"></i>
        </button>
      </div>

      <div class="modal-body-bracket">
        @if (cargandoBracket()) {
          <div class="loading-bracket">
            <div class="spinner"></div>
            <p>Cargando bracket...</p>
          </div>
        } @else if (bracket.length === 0) {
          <div class="empty-bracket">
            <i class="fas fa-sitemap"></i>
            <p>No hay equipos inscritos en este torneo</p>
            <span>Los equipos aparecerán aquí una vez que se inscriban</span>
          </div>
        } @else {
        <div class="bracket-container">
          @for (ronda of bracket; track ronda.ronda) {
            <div class="bracket-ronda">
              <div class="ronda-header">
                <h3>{{ ronda.nombre }}</h3>
              </div>
              <div class="partidos-lista">
                @for (partido of ronda.partidos; track partido.id) {
                  <div class="partido-wrapper">
                    <div class="partido-card">
                      <div class="equipo" [class.ganador]="partido.ganador === 1">
                        @if (partido.equipo1) {
                          <div class="equipo-info">
                            @if (partido.equipo1.logo) {
                              <img [src]="partido.equipo1.logo" [alt]="partido.equipo1.nombre" class="equipo-logo-small">
                            } @else {
                              <div class="equipo-logo-placeholder">
                                <i class="fas fa-shield-alt"></i>
                              </div>
                            }
                            <span class="equipo-nombre">{{ partido.equipo1.nombre }}</span>
                            <span class="equipo-seed">#{{ partido.equipo1.seed }}</span>
                          </div>
                        } @else {
                          <span class="equipo-placeholder">TBD</span>
                        }
                      </div>
                      <div class="vs-divider">VS</div>
                      <div class="equipo" [class.ganador]="partido.ganador === 2">
                        @if (partido.equipo2) {
                          <div class="equipo-info">
                            @if (partido.equipo2.logo) {
                              <img [src]="partido.equipo2.logo" [alt]="partido.equipo2.nombre" class="equipo-logo-small">
                            } @else {
                              <div class="equipo-logo-placeholder">
                                <i class="fas fa-shield-alt"></i>
                              </div>
                            }
                            <span class="equipo-nombre">{{ partido.equipo2.nombre }}</span>
                            <span class="equipo-seed">#{{ partido.equipo2.seed }}</span>
                          </div>
                        } @else {
                          <span class="equipo-placeholder">TBD</span>
                        }
                      </div>
                    </div>
                  </div>
                }
              </div>
            </div>
          }
        </div>
        }
      </div>
    </div>
  </div>
}
