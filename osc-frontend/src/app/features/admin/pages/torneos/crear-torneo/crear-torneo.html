<div class="crear-torneo-container">
  <div class="header-section">
    <h1 class="page-title">
      <i class="fas fa-trophy"></i>
      {{ esEdicion ? 'Editar Torneo' : 'Crear Torneo' }}
    </h1>
    <button class="btn-volver" (click)="volver()">
      <i class="fas fa-arrow-left"></i>
      Volver
    </button>
  </div>

  <form [formGroup]="torneoForm" (ngSubmit)="onSubmit()" class="torneo-form">
    <div class="form-grid">
      <!-- Nombre -->
      <div class="form-group full-width">
        <label for="nombre" class="form-label">
          <i class="fas fa-tag"></i>
          Nombre del Torneo
        </label>
        <input
          type="text"
          id="nombre"
          formControlName="nombre"
          class="form-input"
          placeholder="Ej: Copa de Fútbol 2025"
          [class.invalid]="f['nombre'].invalid && f['nombre'].touched"
        />
        @if (f['nombre'].invalid && f['nombre'].touched) {
        <div class="error-message">
          @if (f['nombre'].errors?.['required']) {
          <span>El nombre es requerido</span>
          }
          @if (f['nombre'].errors?.['minlength']) {
          <span>Mínimo 3 caracteres</span>
          }
        </div>
        }
      </div>

      <!-- Descripción -->
      <div class="form-group full-width">
        <label for="descripcion" class="form-label">
          <i class="fas fa-align-left"></i>
          Descripción (opcional)
        </label>
        <textarea
          id="descripcion"
          formControlName="descripcion"
          class="form-textarea"
          rows="3"
          placeholder="Descripción del torneo..."
        ></textarea>
      </div>

      <!-- Deporte -->
      <div class="form-group dropdown-deporte" [class.activo]="dropdownDeporteAbierto()">
        <label for="id_deporte" class="form-label">
          <i class="fas fa-futbol"></i>
          Deporte
        </label>
        <button
          type="button"
          class="btn-dropdown-custom"
          (click)="toggleDropdownDeporte()"
          [class.invalid]="f['id_deporte'].invalid && f['id_deporte'].touched"
        >
          <span class="dropdown-text">{{ deporteSeleccionado() }}</span>
          <i class="fas fa-chevron-down dropdown-icon" [class.rotado]="dropdownDeporteAbierto()"></i>
        </button>
        @if (dropdownDeporteAbierto()) {
          <div class="dropdown-menu">
            @for (deporte of deportes; track deporte.id_deporte) {
              <div class="dropdown-item" (click)="seleccionarDeporte(deporte)">
                <i class="fas fa-futbol"></i>
                {{ deporte.nombre_deporte }}
              </div>
            }
          </div>
        }
        @if (f['id_deporte'].invalid && f['id_deporte'].touched) {
        <div class="error-message">
          El deporte es requerido
        </div>
        }
      </div>

      <!-- Tipo de Torneo -->
      <div class="form-group dropdown-tipo" [class.activo]="dropdownTipoAbierto()">
        <label for="tipo_torneo" class="form-label">
          <i class="fas fa-sitemap"></i>
          Tipo de Torneo
        </label>
        <button type="button" class="btn-dropdown-custom" (click)="toggleDropdownTipo()">
          <span class="dropdown-text">{{ tipoSeleccionado() }}</span>
          <i class="fas fa-chevron-down dropdown-icon" [class.rotado]="dropdownTipoAbierto()"></i>
        </button>
        @if (dropdownTipoAbierto()) {
          <div class="dropdown-menu">
            @for (tipo of tiposTorneo; track tipo.value) {
              <div class="dropdown-item" (click)="seleccionarTipo(tipo)">
                @if (tipo.value === 'grupo-eliminatoria') {
                  <i class="fas fa-layer-group"></i>
                } @else if (tipo.value === 'eliminatoria-directa') {
                  <i class="fas fa-sitemap"></i>
                } @else if (tipo.value === 'todos-contra-todos') {
                  <i class="fas fa-th"></i>
                } @else if (tipo.value === 'liga') {
                  <i class="fas fa-trophy"></i>
                }
                {{ tipo.label }}
              </div>
            }
          </div>
        }
      </div>

      <!-- Fecha Inicio -->
      <div class="form-group">
        <label for="fecha_inicio" class="form-label">
          <i class="fas fa-calendar-alt"></i>
          Fecha de Inicio
        </label>
        <input
          type="date"
          id="fecha_inicio"
          formControlName="fecha_inicio"
          class="form-input"
          [class.invalid]="f['fecha_inicio'].invalid && f['fecha_inicio'].touched"
          (change)="calcularFechaFin()"
        />
        @if (f['fecha_inicio'].invalid && f['fecha_inicio'].touched) {
        <div class="error-message">
          La fecha de inicio es requerida
        </div>
        }
      </div>

      <!-- Fecha Cierre Inscripción -->
      <div class="form-group">
        <label for="fecha_cierre_inscripcion" class="form-label">
          <i class="fas fa-calendar-times"></i>
          Cierre de Inscripción
        </label>
        <input
          type="datetime-local"
          id="fecha_cierre_inscripcion"
          formControlName="fecha_cierre_inscripcion"
          class="form-input"
        />
        <small class="form-hint">Opcional: Fecha límite para inscripciones</small>
      </div>

      <!-- Máximo de Equipos -->
      <div class="form-group">
        <label for="max_equipos" class="form-label">
          <i class="fas fa-users"></i>
          Número de Participantes
        </label>
        <div class="cantidad-control-input">
          <button type="button" class="btn-cantidad" (click)="cambiarCantidadParticipantes('disminuir')">
            <i class="fas fa-minus"></i>
          </button>
          <input
            type="number"
            id="max_equipos"
            formControlName="max_equipos"
            class="form-input cantidad-display-input"
            [value]="cantidadParticipantes"
            readonly
          />
          <button type="button" class="btn-cantidad" (click)="cambiarCantidadParticipantes('aumentar')">
            <i class="fas fa-plus"></i>
          </button>
        </div>
        <small class="form-hint">Potencias de 2: 2, 4, 8, 16, 32, 64 participantes</small>
      </div>

      <!-- Estado -->
      <div class="form-group dropdown-estado" [class.activo]="dropdownEstadoAbierto()">
        <label for="estado" class="form-label">
          <i class="fas fa-flag"></i>
          Estado
        </label>
        <button type="button" class="btn-dropdown-custom" (click)="toggleDropdownEstado()">
          <span class="dropdown-text">{{ estadoSeleccionado() }}</span>
          <i class="fas fa-chevron-down dropdown-icon" [class.rotado]="dropdownEstadoAbierto()"></i>
        </button>
        @if (dropdownEstadoAbierto()) {
          <div class="dropdown-menu" (click)="$event.stopPropagation()">
            @for (estado of estadosPosibles; track estado.value) {
              <div class="dropdown-item" (click)="seleccionarEstado(estado)">
                @if (estado.value === 'abierto') {
                  <i class="fas fa-door-open"></i>
                } @else if (estado.value === 'en_curso') {
                  <i class="fas fa-play-circle"></i>
                } @else if (estado.value === 'cerrado') {
                  <i class="fas fa-lock"></i>
                } @else if (estado.value === 'finalizado') {
                  <i class="fas fa-flag-checkered"></i>
                }
                {{ estado.label }}
              </div>
            }
          </div>
        }
      </div>

      <!-- Días de Juego -->
      <div class="form-group full-width">
        <label class="form-label">
          <i class="fas fa-calendar-week"></i>
          Días de Juego
        </label>
        <div class="dias-semana-grid">
          @for (dia of diasSemana; track dia.value) {
            <button
              type="button"
              class="btn-dia"
              [class.activo]="dia.checked"
              (click)="toggleDiaJuego(dia)"
            >
              {{ dia.label }}
            </button>
          }
        </div>
        <small class="form-hint">Selecciona los días en que se jugarán los partidos</small>
      </div>

      <!-- Sede -->
      <div class="form-group dropdown-sede" [class.activo]="dropdownSedeAbierto()">
        <label for="id_sede" class="form-label">
          <i class="fas fa-map-marker-alt"></i>
          Sede
        </label>
        <button
          type="button"
          class="btn-dropdown-custom"
          (click)="toggleDropdownSede()"
          [class.invalid]="f['id_sede'].invalid && f['id_sede'].touched"
        >
          <span class="dropdown-text">{{ sedeSeleccionada() }}</span>
          <i class="fas fa-chevron-down dropdown-icon" [class.rotado]="dropdownSedeAbierto()"></i>
        </button>
        @if (dropdownSedeAbierto()) {
          <div class="dropdown-menu">
            @for (sede of sedes; track sede.id_sede) {
              <div class="dropdown-item" (click)="seleccionarSede(sede)">
                <i class="fas fa-building"></i>
                {{ sede.nombre_sede }}
              </div>
            }
          </div>
        }
        @if (f['id_sede'].invalid && f['id_sede'].touched) {
        <div class="error-message">
          La sede es requerida
        </div>
        }
      </div>

      <!-- Horario de Inicio -->
      <div class="form-group">
        <label for="horario_inicio" class="form-label">
          <i class="fas fa-clock"></i>
          Horario de Inicio
        </label>
        <select
          id="horario_inicio"
          formControlName="horario_inicio"
          class="form-input"
          (change)="seleccionarHorarioInicio($any($event.target).value)"
        >
          @for (horario of horariosInicio; track horario) {
            <option [value]="horario">{{ horario }}</option>
          }
        </select>
        <small class="form-hint">Hora de inicio del primer partido del día</small>
      </div>

      <!-- Partidos por Día -->
      <div class="form-group">
        <label for="partidos_por_dia" class="form-label">
          <i class="fas fa-list-ol"></i>
          Partidos por Día
        </label>
        <input
          type="number"
          id="partidos_por_dia"
          formControlName="partidos_por_dia"
          class="form-input"
          [min]="1"
          [max]="getMaxPartidosPorDia()"
          placeholder="3"
          (change)="calcularHorariosDisponibles(); calcularFechaFin()"
        />
        @if (f['partidos_por_dia'].invalid && f['partidos_por_dia'].touched) {
        <div class="error-message">
          Máximo {{ getMaxPartidosPorDia() }} partidos para este torneo
        </div>
        }
        <small class="form-hint">Cantidad máxima de partidos por día (máx: {{ getMaxPartidosPorDia() }})</small>
      </div>

      <!-- Vista Previa de Horarios -->
      @if (horariosCalculados().length > 0) {
      <div class="form-group full-width">
        <label class="form-label">
          <i class="fas fa-calendar-day"></i>
          Horarios Calculados
          <span class="badge-info">{{ getDuracionDeporte() }}h por partido</span>
        </label>
        <div class="horarios-preview">
          @for (horario of horariosCalculados(); track horario; let i = $index) {
            <div class="horario-item">
              <span class="numero-partido">Partido {{ i + 1 }}</span>
              <span class="hora-partido">{{ horario }}</span>
            </div>
          }
        </div>
        <small class="form-hint">Los partidos se programarán automáticamente en estos horarios</small>
      </div>
      }

      <!-- Fecha Fin Calculada -->
      @if (fechaFinCalculada()) {
      <div class="form-group">
        <label class="form-label">
          <i class="fas fa-calculator"></i>
          Fecha Fin Estimada
        </label>
        <div class="fecha-calculada">
          {{ fechaFinCalculada() }}
        </div>
        <small class="form-hint">Calculada automáticamente según la configuración</small>
      </div>
      }
    </div>

    <!-- Botones de Acción -->
    <div class="form-actions">
      <button type="button" class="btn-cancelar" (click)="volver()" [disabled]="cargando">
        <i class="fas fa-times"></i>
        Cancelar
      </button>
      <button type="submit" class="btn-guardar" [disabled]="cargando">
        <i class="fas" [ngClass]="cargando ? 'fa-spinner fa-spin' : 'fa-save'"></i>
        {{ cargando ? 'Guardando...' : (esEdicion ? 'Actualizar' : 'Crear') }}
      </button>
    </div>
  </form>
</div>
