<div class="usuarios-container">
  <!-- Filtros y Búsqueda -->
  <div class="filtros-section">
    <div class="search-box">
      <span class="material-icons">search</span>
      <input
        type="text"
        placeholder="Buscar usuarios..."
        (input)="onSearchChange($event)"
        [value]="searchTerm"
      />
    </div>

    <div class="filtro-rol">
      <select (change)="onFiltroRolChange($event)">
        <option value="">Todos los roles</option>
        @for (rol of roles; track rol.value) {
        <option [value]="rol.value">{{ rol.label }}</option>
        }
      </select>
    </div>

    <div class="stat-badge">
      <span class="material-icons">people</span>
      {{ usuariosFiltrados.length }} Usuario{{ usuariosFiltrados.length !== 1 ? 's' : '' }}
    </div>
  </div>

  <!-- Grid de Usuarios -->
  @if (isLoading) {
  <!-- Skeleton Loading -->
  <div class="usuarios-grid">
    @for (item of skeletonItems; track $index) {
    <div class="usuario-card skeleton-card">
      <div class="skeleton-background"></div>
      <div class="card-content">
        <div class="skeleton-avatar"></div>
        <div class="skeleton-info">
          <div class="skeleton-line skeleton-title"></div>
          <div class="skeleton-line skeleton-email"></div>
          <div class="skeleton-line skeleton-badge"></div>
        </div>
        <div class="skeleton-actions">
          <div class="skeleton-button"></div>
          <div class="skeleton-button"></div>
          <div class="skeleton-button"></div>
        </div>
      </div>
    </div>
    }
  </div>
  } @else if (usuariosPaginados.length > 0) {
  <div class="usuarios-grid">
    @for (usuario of usuariosPaginados; track usuario.uid) {
    <div class="usuario-card">
      <!-- Background con blur -->
      <div class="card-background" [style.background-image]="'url(' + usuario.photoURL + ')'"></div>

      <!-- Contenido -->
      <div class="card-content">
        <!-- Foto de perfil circular -->
        <div class="foto-perfil">
          <img [src]="usuario.photoURL" (error)="onImageError($event, usuario)" />
        </div>

        <!-- Información del usuario -->
        <div class="usuario-info">
          <h3>{{ usuario.displayName }}</h3>
          <p class="email">{{ usuario.email }}</p>

          <!-- Badge de rol (protecciones: evita leer propiedades de undefined) -->
          <span
            class="rol-badge"
            [style.background]="getRolInfo($any(usuario.customClaims?.role ?? ''))?.color"
          >
            {{ getRolInfo($any(usuario.customClaims?.role ?? ''))?.label || 'Sin rol' }}
          </span>
        </div>

        <!-- Acciones -->
        <div class="usuario-actions">
          <button
            class="btn-action btn-cambiar-rol"
            (click)="abrirModalCambiarRol(usuario)"
            title="Modificar rol"
          >
            <span class="material-icons">admin_panel_settings</span>
            Cambiar Rol
          </button>

          <button
            class="btn-action btn-quitar-rol"
            (click)="quitarRol(usuario)"
            [disabled]="usuario.customClaims.role === 'Cliente'"
            title="Quitar rol"
          >
            <span class="material-icons">remove_circle</span>
            Quitar Rol
          </button>

          <button
            class="btn-action btn-eliminar"
            (click)="confirmarEliminar(usuario)"
            title="Eliminar usuario"
          >
            <span class="material-icons">delete</span>
            Eliminar
          </button>
        </div>
      </div>
    </div>
    }
  </div>
  } @else {
  <div class="empty-state">
    <div class="empty-icon">
      <span class="material-icons">people_outline</span>
    </div>
    <h3>No se encontraron usuarios</h3>
    <p>Intenta ajustar los filtros de búsqueda</p>
  </div>
  }

  <!-- Paginación -->
  @if (totalPages > 1) {
  <div class="pagination">
    <button
      class="page-btn"
      (click)="cambiarPagina(currentPage - 1)"
      [disabled]="currentPage === 1"
    >
      <span class="material-icons">chevron_left</span>
    </button>

    @for (page of pages; track page) {
    <button class="page-btn" [class.active]="page === currentPage" (click)="cambiarPagina(page)">
      {{ page }}
    </button>
    }

    <button
      class="page-btn"
      (click)="cambiarPagina(currentPage + 1)"
      [disabled]="currentPage === totalPages"
    >
      <span class="material-icons">chevron_right</span>
    </button>
  </div>
  }
</div>

<!-- Modal de Cambiar Rol -->
@if (mostrarModalCambiarRol) {
<div class="modal-overlay" (click)="cerrarModalCambiarRol()">
  <div class="modal-cambiar-rol" (click)="$event.stopPropagation()">
    <div class="modal-header">
      <h2>Cambiar Rol de Usuario</h2>
      <button class="btn-close-modal" (click)="cerrarModalCambiarRol()">
        <span class="material-icons">close</span>
      </button>
    </div>

    @if (usuarioSeleccionado) {
    <div class="modal-body">
      <p class="modal-subtitle">
        Selecciona el nuevo rol para <strong>{{ usuarioSeleccionado.displayName }}</strong>
      </p>

      <div class="roles-grid">
        @for (rol of roles; track rol.value) {
        <label class="rol-option" [class.selected]="nuevoRol === rol.value">
          <input type="radio" name="rol" [value]="rol.value" [(ngModel)]="nuevoRol" />
          <div class="rol-card" [style.border-color]="rol.color">
            <span class="rol-icon material-icons">
              {{
                rol.value === 'Admin'
                  ? 'manage_accounts'
                  : rol.value === 'Arbitro'
                  ? 'sports_soccer'
                  : 'person'
              }}
            </span>
            <span class="rol-name" [style.color]="rol.color">{{ rol.label }}</span>
          </div>
        </label>
        }
      </div>
    </div>
    }

    <div class="modal-footer">
      <button class="btn-modal btn-cancelar" (click)="cerrarModalCambiarRol()">Cancelar</button>
      <button
        class="btn-modal btn-confirmar"
        (click)="cambiarRolUsuario()"
        [disabled]="!nuevoRol || nuevoRol === usuarioSeleccionado?.customClaims?.role"
      >
        Cambiar Rol
      </button>
    </div>
  </div>
</div>
}

<!-- Modal de Confirmación de Eliminación -->
@if (mostrarModalEliminar) {
<div class="modal-overlay" (click)="cerrarModalEliminar()">
  <div class="modal-eliminar" (click)="$event.stopPropagation()">
    <div class="modal-icon-warning">
      <span class="material-icons">warning</span>
    </div>
    <h2>¿Eliminar usuario?</h2>
    @if (usuarioSeleccionado) {
    <p>
      ¿Estás seguro de que deseas eliminar a
      <strong>{{ getNombre(usuarioSeleccionado) }}</strong
      >? Esta acción no se puede deshacer.
    </p>
    }

    <div class="modal-actions">
      <button class="btn-modal btn-cancelar" (click)="cerrarModalEliminar()">Cancelar</button>
      <button class="btn-modal btn-confirmar-eliminar" (click)="eliminarUsuario()">Eliminar</button>
    </div>
  </div>
</div>
}
